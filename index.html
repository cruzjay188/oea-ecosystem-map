<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ecosystem Map</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Lora:ital,wght@0,600;1,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<style>
:root {
  --ink:     #1A1A2E;
  --ink2:    #3A3A5A;
  --muted:   #7A7A9A;
  --border:  rgba(0,0,0,0.08);
  --broken:  #D93030;
  --strained:#D48020;
  --healthy: #48A860;
  --sidebar-w: 340px;
}

*,*::before,*::after { box-sizing:border-box; margin:0; padding:0; }
html,body { height:100%; overflow:hidden; }
body { background:#FFF; color:var(--ink); font-family:'Inter',sans-serif; display:flex; flex-direction:column; }

/* ── CONTROLS (single row, prominent) ───────────────────── */
#nav {
  background: #FFFFFF;
  border-bottom: 1.5px solid rgba(0,0,0,0.07);
  display: flex;
  align-items: center;
  padding: 0 18px;
  height: 48px;
  gap: 12px;
  flex-shrink: 0;
  box-shadow: 0 2px 10px rgba(0,0,0,0.06);
  z-index: 400;
}

/* Journey phase pills — primary nav */
.nav-label {
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--muted);
  flex-shrink: 0;
  white-space: nowrap;
}

.phase-bar {
  display: flex;
  align-items: center;
  gap: 3px;
  background: #F2F1F8;
  border: 1px solid rgba(0,0,0,0.07);
  border-radius: 22px;
  padding: 3px 4px;
  flex-shrink: 0;
}
.phase-pill {
  padding: 5px 13px;
  border-radius: 16px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  color: var(--muted);
  border: none;
  background: transparent;
  font-family: 'Inter', sans-serif;
  white-space: nowrap;
  transition: all .15s;
  letter-spacing: -0.01em;
}
.phase-pill:hover { color: var(--ink); background: rgba(255,255,255,0.7); }
.phase-pill.active { background: var(--ink); color: #FFF; font-weight: 700; }
.phase-pill.crit.active { background: var(--broken); }

.nav-div { width: 1px; height: 22px; background: rgba(0,0,0,0.08); flex-shrink: 0; }

/* Flow view filters */
.view-bar {
  display: flex;
  align-items: center;
  gap: 3px;
  flex-shrink: 0;
}
.vbtn {
  height: 30px;
  padding: 0 11px;
  border-radius: 8px;
  border: 1.5px solid rgba(0,0,0,0.08);
  background: transparent;
  font-family: 'Inter', sans-serif;
  font-size: 11px;
  font-weight: 600;
  color: var(--muted);
  cursor: pointer;
  white-space: nowrap;
  transition: all .14s;
  letter-spacing: -0.01em;
}
.vbtn:hover { color: var(--ink); border-color: rgba(0,0,0,0.18); }
.vbtn.active { background: var(--ink); color: #FFF; border-color: var(--ink); }
.vbtn.fric.active { background: var(--broken); border-color: var(--broken); }

/* Panel toggle — right side */
#panel-btn {
  margin-left: auto;
  height: 30px;
  padding: 0 12px;
  border-radius: 8px;
  border: 1.5px solid rgba(0,0,0,0.1);
  background: transparent;
  font-family: 'Inter', sans-serif;
  font-size: 11px;
  font-weight: 600;
  color: var(--muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all .14s;
  flex-shrink: 0;
}
#panel-btn:hover { color: var(--ink); border-color: rgba(0,0,0,0.22); }
#panel-btn.active { background: var(--ink); color: #FFF; border-color: var(--ink); }

/* ── MAIN ──────────────────────────────────────────────── */
#main { flex: 1; display: flex; overflow: hidden; }
#cvs  { flex: 1; position: relative; overflow: hidden; background: #FFFFFF; }
svg#g { width: 100%; height: 100%; cursor: grab; }
svg#g.dragging { cursor: grabbing; }

/* ── PHASE BANNER (replaces top-left scope strip) ──────── */
#phase-banner {
  position: absolute;
  top: 14px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 200;
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(12px);
  border: 1.5px solid rgba(0,0,0,0.09);
  border-radius: 24px;
  padding: 6px 16px 6px 10px;
  font-size: 12px;
  font-weight: 700;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  opacity: 0;
  transition: opacity .3s;
  pointer-events: none;
}
#phase-banner.show { opacity: 1; }
#pb-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }

/* ── LEGEND (translucent, bottom-left) ─────────────────── */
#legend {
  position: absolute;
  bottom: 16px;
  left: 16px;
  z-index: 200;
  width: 218px;
  background: rgba(255,255,255,0.78);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border: 1px solid rgba(0,0,0,0.07);
  border-radius: 12px;
  padding: 14px 15px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}
.leg-sec { margin-bottom: 12px; }
.leg-sec:last-child { margin-bottom: 0; }
.leg-head {
  font-size: 8px;
  font-weight: 800;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 7px;
}
.leg-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 2px 4px;
  margin-bottom: 2px;
  border-radius: 5px;
  transition: background .12s;
  cursor: default;
}
.leg-row:hover { background: rgba(0,0,0,0.04); }
.leg-dot { width: 11px; height: 11px; border-radius: 50%; flex-shrink: 0; }
.leg-dot.risk-dot { background: #FFF !important; border: 2px dashed var(--broken); }
.leg-line { width: 22px; height: 2.5px; border-radius: 2px; flex-shrink: 0; }
.leg-line.dashed-line { background: none !important; border-top: 2.5px dashed var(--broken); height: 0; margin-top: 1px; }
.leg-lbl { font-size: 10.5px; font-weight: 500; color: var(--ink2); }

/* ── ZOOM (bottom-right) ───────────────────────────────── */
#zoom-wrap { position: absolute; bottom: 16px; right: 16px; z-index: 200; display: flex; flex-direction: column; gap: 4px; }
.zbtn { width: 34px; height: 34px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.88); backdrop-filter: blur(8px); color: var(--ink); font-size: 16px; font-weight: 400; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 6px rgba(0,0,0,0.07); transition: all .13s; }
.zbtn:hover { background: var(--ink); color: #FFF; border-color: var(--ink); }

/* ── SIDEBAR ───────────────────────────────────────────── */
#sidebar {
  width: var(--sidebar-w);
  background: #FAFAF8;
  border-left: 1.5px solid rgba(0,0,0,0.07);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: width .28s cubic-bezier(.4,0,.2,1);
  flex-shrink: 0;
}
#sidebar.closed { width: 0; }
.sb-head {
  padding: 16px 18px 12px;
  border-bottom: 1px solid rgba(0,0,0,0.07);
  flex-shrink: 0;
  background: #FFF;
}
.sb-kicker { font-size: 8.5px; font-weight: 800; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin-bottom: 4px; }
.sb-title { font-family: 'Lora', serif; font-size: 15px; font-weight: 600; color: var(--ink); line-height: 1.25; }
.sb-body { flex: 1; overflow-y: auto; }
.sb-body::-webkit-scrollbar { width: 3px; }
.sb-body::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.08); border-radius: 2px; }

.sb-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 28px 22px; text-align: center; gap: 14px; }
.sb-empty-icon { font-size: 2.6rem; opacity: 0.12; }
.sb-empty-hint { font-size: 12px; font-weight: 600; color: var(--ink2); }
.sb-empty-desc { font-size: 11px; color: var(--muted); line-height: 1.7; }

.sbs { padding: 14px 18px; border-bottom: 1px solid rgba(0,0,0,0.06); }
.sbs:last-child { border-bottom: none; }
.sbs-head { font-size: 8.5px; font-weight: 800; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 9px; display: flex; align-items: center; justify-content: space-between; }
.sbs-count { background: rgba(0,0,0,0.05); border-radius: 9px; padding: 1px 7px; font-size: 8.5px; font-weight: 700; color: var(--muted); }

.node-badge { display: inline-flex; align-items: center; gap: 6px; padding: 5px 11px; border-radius: 20px; font-size: 9px; font-weight: 800; letter-spacing: 0.07em; text-transform: uppercase; margin-bottom: 10px; }
.sb-desc { font-size: 11.5px; line-height: 1.75; color: var(--ink2); }
.status-row { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
.stag { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 20px; font-size: 9px; font-weight: 700; border: 1.5px solid; }
.stag.broken   { color: var(--broken);  border-color: rgba(217,48,48,0.3);  background: rgba(217,48,48,0.06); }
.stag.strained { color: var(--strained);border-color: rgba(212,128,32,0.3); background: rgba(212,128,32,0.06); }
.stag.healthy  { color: var(--healthy); border-color: rgba(72,168,96,0.3);  background: rgba(72,168,96,0.06); }
.stag.inscope  { color: #2E7A46; border-color: rgba(72,168,96,0.3); background: rgba(72,168,96,0.06); }
.stag.outscope { color: var(--muted); border-color: rgba(0,0,0,0.08); background: rgba(0,0,0,0.03); }

.inf-bar { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
.inf-row { display: flex; align-items: center; gap: 8px; }
.inf-lbl { width: 90px; font-size: 8.5px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); flex-shrink: 0; }
.inf-track { flex: 1; height: 5px; background: rgba(0,0,0,0.07); border-radius: 3px; overflow: hidden; }
.inf-fill { height: 100%; border-radius: 3px; transition: width .5s .1s; }
.inf-val { width: 26px; text-align: right; font-size: 10px; font-weight: 700; color: var(--ink); flex-shrink: 0; }

.goal-list { display: flex; flex-direction: column; gap: 7px; }
.goal-item { display: flex; align-items: flex-start; gap: 9px; font-size: 11.5px; line-height: 1.6; color: var(--ink2); }
.goal-dot { width: 5px; height: 5px; border-radius: 50%; margin-top: 6px; flex-shrink: 0; }

.pain-card { background: rgba(217,48,48,0.05); border: 1px solid rgba(217,48,48,0.15); border-radius: 8px; padding: 11px 13px; margin-bottom: 7px; font-size: 11px; line-height: 1.65; color: var(--ink2); word-break: break-word; }
.pain-head { font-weight: 700; color: var(--broken); font-size: 10.5px; margin-bottom: 4px; }
.int-card { background: rgba(72,168,96,0.06); border: 1px solid rgba(72,168,96,0.2); border-radius: 8px; padding: 11px 13px; margin-bottom: 7px; word-break: break-word; }
.int-head { font-weight: 700; font-size: 11px; color: #2A7040; margin-bottom: 3px; }
.int-body { font-size: 10.5px; color: var(--ink2); line-height: 1.6; }
.ch-wrap { display: flex; flex-wrap: wrap; gap: 5px; }
.ch-pill { padding: 4px 9px; border-radius: 6px; font-size: 9.5px; font-weight: 600; white-space: nowrap; }

.flow-list { display: flex; flex-direction: column; gap: 7px; }
.flow-card { display: flex; gap: 9px; background: #FFF; border: 1px solid rgba(0,0,0,0.07); border-radius: 9px; padding: 10px 12px; cursor: pointer; transition: all .12s; min-width: 0; }
.flow-card:hover { border-color: rgba(0,0,0,0.15); box-shadow: 0 2px 10px rgba(0,0,0,0.07); }
.flow-dot { width: 7px; height: 7px; border-radius: 50%; margin-top: 5px; flex-shrink: 0; }
.flow-inner { flex: 1; min-width: 0; overflow: hidden; }
.flow-dir { font-size: 8.5px; font-weight: 800; letter-spacing: 0.07em; text-transform: uppercase; color: var(--muted); margin-bottom: 2px; }
.flow-lbl { font-size: 11.5px; color: var(--ink); line-height: 1.4; font-weight: 500; word-break: break-word; }
.flow-status { margin-top: 4px; padding: 2px 8px; border-radius: 4px; font-size: 9px; font-weight: 700; display: inline-block; line-height: 1.5; }
.flow-status.broken   { background: rgba(217,48,48,0.09);  color: var(--broken); }
.flow-status.strained { background: rgba(212,128,32,0.09); color: var(--strained); }
.flow-status.healthy  { background: rgba(72,168,96,0.09);  color: var(--healthy); }

.conn-wrap { display: flex; flex-wrap: wrap; gap: 5px; }
.conn-chip { padding: 5px 11px; border-radius: 20px; font-size: 10.5px; font-weight: 600; cursor: pointer; border: 1.5px solid; background: #FFF; transition: all .12s; }
.conn-chip:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.1); }

/* ── TOOLTIP ───────────────────────────────────────────── */
#tt { position: fixed; z-index: 999; pointer-events: none; opacity: 0; transition: opacity .1s; background: rgba(18,18,30,0.93); color: #EEE; padding: 9px 13px; border-radius: 9px; max-width: 220px; font-size: 11.5px; line-height: 1.45; box-shadow: 0 6px 22px rgba(0,0,0,0.22); }
#tt.show { opacity: 1; }
.tt-name { font-weight: 700; font-size: 12.5px; }
.tt-sub  { font-size: 10px; opacity: 0.5; margin-top: 1px; }
.tt-st   { margin-top: 5px; font-size: 9.5px; font-weight: 700; padding: 2px 8px; border-radius: 4px; display: inline-block; }

@keyframes dash-flow { to { stroke-dashoffset: -18; } }
@keyframes pulse-ring { 0%,100%{opacity:.28;transform:scale(1)} 50%{opacity:.10;transform:scale(1.07)} }
.pulse-el { animation: pulse-ring 3.5s ease-in-out infinite; transform-origin: center; }
.dash-anim { animation: dash-flow 1.1s linear infinite; }
@keyframes sb-in { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:none} }
.sb-ani { animation: sb-in .2s ease forwards; }
</style>
</head>
<body>

<!-- ── CONTROLS ──────────────────────────────────────── -->
<div id="nav">
  <span class="nav-label">Journey Phase</span>
  <div class="phase-bar">
    <button class="phase-pill active" data-phase="all">All</button>
    <button class="phase-pill" data-phase="discovery">Discovery</button>
    <button class="phase-pill" data-phase="application">Application</button>
    <button class="phase-pill crit" data-phase="post-deposit">⚠ Post-Deposit</button>
    <button class="phase-pill" data-phase="departure">Departure</button>
    <button class="phase-pill" data-phase="post-abroad">Post-Abroad</button>
  </div>

  <div class="nav-div"></div>
  <span class="nav-label">Show Flows</span>
  <div class="view-bar">
    <button class="vbtn active" data-view="all">All</button>
    <button class="vbtn" data-view="info">Information</button>
    <button class="vbtn" data-view="financial">Financial</button>
    <button class="vbtn" data-view="emotional">Emotional</button>
    <button class="vbtn fric" data-view="friction">⚠ Friction Only</button>
  </div>

  <button id="panel-btn" class="active">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
    Detail Panel
  </button>
</div>

<!-- ── MAIN ────────────────────────────────────────────── -->
<div id="main">
  <div id="cvs">

    <!-- Active phase banner (center top, shown when phase selected) -->
    <div id="phase-banner">
      <div id="pb-dot"></div>
      <span id="pb-text"></span>
    </div>

    <svg id="g">
      <defs>
        <!-- Arrowheads — one per flow type, normal + highlighted -->
        <marker id="arr-info"       markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0.5L0,5.5L6,3z" fill="#5090C0" opacity="0.75"/></marker>
        <marker id="arr-financial"  markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0.5L0,5.5L6,3z" fill="#D48020" opacity="0.75"/></marker>
        <marker id="arr-emotional"  markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0.5L0,5.5L6,3z" fill="#A04080" opacity="0.75"/></marker>
        <marker id="arr-authority"  markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0.5L0,5.5L6,3z" fill="#5040A0" opacity="0.75"/></marker>
        <marker id="arr-task"       markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0.5L0,5.5L6,3z" fill="#48A860" opacity="0.75"/></marker>
        <marker id="arr-risk"       markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0.5L0,5.5L6,3z" fill="#D93030" opacity="0.9"/></marker>
        <marker id="arr-info-hi"      markerWidth="7" markerHeight="7" refX="5.5" refY="3.5" orient="auto"><path d="M0,0.5L0,6.5L7,3.5z" fill="#2060A0"/></marker>
        <marker id="arr-financial-hi" markerWidth="7" markerHeight="7" refX="5.5" refY="3.5" orient="auto"><path d="M0,0.5L0,6.5L7,3.5z" fill="#B06010"/></marker>
        <marker id="arr-emotional-hi" markerWidth="7" markerHeight="7" refX="5.5" refY="3.5" orient="auto"><path d="M0,0.5L0,6.5L7,3.5z" fill="#802060"/></marker>
        <marker id="arr-authority-hi" markerWidth="7" markerHeight="7" refX="5.5" refY="3.5" orient="auto"><path d="M0,0.5L0,6.5L7,3.5z" fill="#3030A0"/></marker>
        <marker id="arr-task-hi"      markerWidth="7" markerHeight="7" refX="5.5" refY="3.5" orient="auto"><path d="M0,0.5L0,6.5L7,3.5z" fill="#308050"/></marker>
        <marker id="arr-risk-hi"      markerWidth="7" markerHeight="7" refX="5.5" refY="3.5" orient="auto"><path d="M0,0.5L0,6.5L7,3.5z" fill="#B01010"/></marker>
      </defs>
      <g id="groot"></g>
    </svg>

    <!-- Legend — translucent -->
    <div id="legend">
      <div class="leg-sec">
        <div class="leg-head">Stakeholder Type</div>
        <div class="leg-row"><div class="leg-dot" style="background:#EFE534;border:1.5px solid #C8BC00"></div><span class="leg-lbl">OEA Units + Program Leadership</span></div>
        <div class="leg-row"><div class="leg-dot" style="background:#74C84E;border:1.5px solid #50A030"></div><span class="leg-lbl">Outbound Student (Primary Actor)</span></div>
        <div class="leg-row"><div class="leg-dot" style="background:#52B86A;border:1.5px solid #38984A"></div><span class="leg-lbl">Financial &amp; Academic Support</span></div>
        <div class="leg-row"><div class="leg-dot" style="background:#7A6E26;border:1.5px solid #584E10"></div><span class="leg-lbl">Partner Institutions</span></div>
        <div class="leg-row"><div class="leg-dot" style="background:#CBB186;border:1.5px solid #A89060"></div><span class="leg-lbl">Student Stakeholders</span></div>
        <div class="leg-row"><div class="leg-dot" style="background:#A8D8F4;border:1.5px solid #5090C0"></div><span class="leg-lbl">Digital Channels</span></div>
        <div class="leg-row"><div class="leg-dot" style="background:#EAE6FA;border:1.5px solid #9080CC"></div><span class="leg-lbl">Administration</span></div>
        <div class="leg-row"><div class="leg-dot risk-dot"></div><span class="leg-lbl">External Risk Factors</span></div>
      </div>
      <div class="leg-sec">
        <div class="leg-head">Relationship Health</div>
        <div class="leg-row"><div class="leg-dot" style="background:#D93030"></div><span class="leg-lbl">⚠ Broken — drives withdrawals</span></div>
        <div class="leg-row"><div class="leg-dot" style="background:#D48020"></div><span class="leg-lbl">~ Strained — needs attention</span></div>
        <div class="leg-row"><div class="leg-dot" style="background:#48A860"></div><span class="leg-lbl">✓ Functioning well</span></div>
      </div>
    </div>

    <div id="zoom-wrap">
      <button class="zbtn" id="zi">+</button>
      <button class="zbtn" id="zo">−</button>
      <button class="zbtn" id="zf" title="Fit all">⊙</button>
    </div>
  </div>

  <!-- ── SIDEBAR ────────────────────────────────────── -->
  <div id="sidebar">
    <div class="sb-head">
      <div class="sb-kicker" id="sb-kicker">Stakeholder Detail</div>
      <div class="sb-title" id="sb-title">Click any node</div>
    </div>
    <div class="sb-body" id="sb-body">
      <div class="sb-empty">
        <div class="sb-empty-icon">◉</div>
        <div class="sb-empty-hint">Click any node to explore</div>
        <div class="sb-empty-desc">See goals, friction points, value flows, and design interventions for each stakeholder in the ecosystem.</div>
      </div>
    </div>
  </div>
</div>

<div id="tt">
  <div class="tt-name" id="tt-name"></div>
  <div class="tt-sub"  id="tt-sub"></div>
  <div class="tt-st"   id="tt-st"></div>
</div>

<script>
// ═══════════════════════════════════════════════════════
// PALETTE
// ═══════════════════════════════════════════════════════
const CAT = {
  oea:     { fill:'#EFE534', stroke:'#B8AC00', text:'#1A1800', label:'OEA Unit' },
  admin:   { fill:'#EAE6FA', stroke:'#9080CC', text:'#3A2A80', label:'Administration' },
  channel: { fill:'#A8D8F4', stroke:'#5090C0', text:'#003058', label:'Digital Channel' },
  partner: { fill:'#7A6E26', stroke:'#504808', text:'#FFFFFF', label:'Partner Institution' },
  support: { fill:'#52B86A', stroke:'#38984A', text:'#FFFFFF', label:'Financial & Academic' },
  student: { fill:'#CBB186', stroke:'#A89060', text:'#2A1800', label:'Student Stakeholder' },
  primary: { fill:'#74C84E', stroke:'#50A030', text:'#0E2A04', label:'Primary Actor' },
  risk:    { fill:'#FFFFFF', stroke:'#D93030', text:'#C02020', label:'Risk Factor', dashed:true },
};

const FLOW = {
  info:      { color:'#5090C0', label:'Information' },
  financial: { color:'#D48020', label:'Financial' },
  emotional: { color:'#A04080', label:'Emotional' },
  authority: { color:'#5040A0', label:'Authority' },
  task:      { color:'#48A860', label:'Task' },
  risk:      { color:'#D93030', label:'Risk' },
};

const ALL = ['discovery','application','post-deposit','departure','post-abroad'];

// ── GROUP ELLIPSES ──────────────────────────────────────
const GROUPS = [
  { label:'OEA Exchange Program',      cx:-268, cy:118, rx:185, ry:148, lx:-435, ly:-30 },
  { label:'OEA Faculty-led Program',   cx: 348, cy:118, rx:205, ry:158, lx: 448, ly:-45 },
  { label:'External Risk Factors',     cx: -65, cy:527, rx:318, ry: 78, lx:-362, ly:487 },
];

// ── NODES ───────────────────────────────────────────────
// Font scale bumped: r * 0.28 (was 0.21) for much better readability
const NODES = [
  { id:'pratt-oea', label:'Pratt OEA', sub:'Office of Education Abroad', cat:'oea', r:58,
    phases:ALL, scope:'in', power:90, interest:95, emotionalLoad:80,
    desc:'The institutional backbone of all outbound study abroad at Pratt. Coordinates both faculty-led and semester-exchange programs and manages partner relationships. The primary support system students should — but often can\'t — easily access.',
    painPoints:[
      { head:'Fragmented Communication Hub', body:'OEA sends critical info via Terra Dotta, email, and PDF. Students must reconcile 3 channels with no single source of truth.' },
      { head:'Coordination Overload', body:'Small staff managing concurrent programs while fielding last-minute student questions that proactive systems could prevent.' }
    ],
    goals:['Increase student retention post-deposit','Maintain 30+ partner relationships','Ensure program viability through enrollment'],
    channels:['Terra Dotta','Email','In-person office hours'],
    interventions:['Planner Passport: centralized step-by-step tracker','Support Suitcase: structured orientation resource','Standardized faculty communication protocols'],
    x:0, y:0 },

  { id:'oea-exchange', label:'OEA Exchange Program', sub:'Semester-long', cat:'oea', r:50,
    phases:ALL, scope:'in', power:70, interest:85, emotionalLoad:60,
    desc:'Manages full-semester exchanges placing Pratt students at partner universities globally. Bilateral agreements require reciprocal student exchange.',
    painPoints:[{ head:'Credit Transfer Opacity', body:'Students unsure if abroad credits count toward their degree before committing.' }],
    goals:['Place students at partner schools','Maintain reciprocal exchange agreements','Ensure seamless credit transfer'],
    channels:['Terra Dotta','Email','Partner portals'],
    x:-238, y:58 },

  { id:'oea-faculty', label:'OEA Faculty-led Program', sub:'Short-term · Critical', cat:'oea', r:50,
    phases:ALL, scope:'in', power:70, interest:90, emotionalLoad:75,
    desc:'Short-term programs led by Pratt faculty. HIGHEST WITHDRAWAL RISK — 39.28% withdraw post-deposit. Compressed timelines create compounding pressure around visa, finance, and logistics.',
    painPoints:[
      { head:'Post-Deposit Danger Zone', body:'After deposit, students face visa docs, insurance, payments, and approvals simultaneously with no clear sequence.' },
      { head:'Faculty Admin Overload', body:'Faculty absorb admin tasks outside their academic role, creating inconsistent student communication across programs.' }
    ],
    goals:['Retain students post-deposit','Deliver enriching short-term experiences','Reduce admin burden on faculty'],
    channels:['Terra Dotta','Email','Canvas'],
    interventions:['Standardized pre-departure communication timeline','Faculty admin handoff to OEA staff'],
    x:238, y:58 },

  { id:'oea-staff-ex', label:'OEA Staff', sub:'Exchange · Olivia, Paige', cat:'oea', r:27,
    phases:ALL, scope:'in', power:55, interest:85, emotionalLoad:70,
    desc:'Day-to-day operations staff for the Exchange Program. Primary student contact for logistics, documentation, and support queries.',
    painPoints:[{ head:'Reactive Support Model', body:'Staff field urgent queries that proper proactive communication could prevent.' }],
    goals:['Process applications efficiently','Support students through documentation'],
    channels:['Email','Terra Dotta','In-person'],
    x:-318, y:182 },

  { id:'oea-staff-fl', label:'OEA Staff', sub:'Faculty-led · Paige, Topeka', cat:'oea', r:27,
    phases:ALL, scope:'in', power:55, interest:85, emotionalLoad:75,
    desc:'Coordinates faculty-led program logistics. Often the last line of support when students are overwhelmed in the post-deposit phase.',
    painPoints:[{ head:'Surge Support Load', body:'Disproportionate contact volume in the post-deposit window when uncertainty peaks.' }],
    goals:['Coordinate program logistics','Support faculty leaders','Prevent last-minute withdrawals'],
    channels:['Email','Terra Dotta','Phone'],
    x:328, y:182 },

  { id:'faculty-prof', label:'Faculty / Professor', sub:'Program Leader', cat:'oea', r:34,
    phases:['application','post-deposit','departure','post-abroad'], scope:'in', power:65, interest:75, emotionalLoad:65,
    desc:'Pratt faculty who design and lead short-term programs. Currently absorbing admin tasks (visa reminders, logistics) that fall outside their academic role — creating inconsistent student experiences.',
    painPoints:[
      { head:'Role Boundary Erosion', body:'Faculty handle non-academic communication without clear protocols, leading to variable support quality.' },
      { head:'Inconsistent Touchpoints', body:'Pre-departure communication quality varies widely by faculty leader.' }
    ],
    goals:['Lead enriching programs','Maintain research and professional work','Provide bounded student support'],
    channels:['Email','Canvas','Direct messaging'],
    interventions:['Define faculty vs. OEA communication boundaries','Provide faculty with communication templates'],
    x:468, y:62 },

  { id:'pratt-admin', label:'Pratt Administration', sub:'Institutional Governance', cat:'admin', r:42,
    phases:ALL, scope:'out', power:95, interest:50, emotionalLoad:10,
    desc:'Central institutional authority. High power to allocate resources and set policy, but low direct student contact. Terra Dotta constraints and budget limits originate here.',
    painPoints:[{ head:'Institutional Constraint Origin', body:'Platform limitations and budget constraints originate here — OEA must work around them without the ability to change them.' }],
    goals:['Protect Pratt\'s international reputation','Generate tuition revenue','Maintain accreditation'],
    channels:['Internal governance','Budget cycles'],
    x:0, y:-330 },

  { id:'pratt-intl', label:'Pratt International', sub:'Department', cat:'admin', r:32,
    phases:ALL, scope:'out', power:60, interest:65, emotionalLoad:20,
    desc:'Bridges international strategy across Pratt departments. Interfaces between OEA and central administration. Limited direct student impact.',
    goals:['Support international student pipeline','Facilitate cross-departmental coordination'],
    channels:['Internal email','Meetings'],
    x:-238, y:-275 },

  { id:'terra-dotta', label:'Terra Dotta', sub:'Application Platform', cat:'channel', r:36,
    phases:['application','post-deposit'], scope:'out', power:80, interest:0, emotionalLoad:0,
    desc:'The institutional application platform. INSTITUTIONAL CONSTRAINT — out of scope for redesign. Students use it for applications but find information fragmented with no unified task view.',
    painPoints:[
      { head:'Fragmentation Source', body:'Students must cross-reference Terra Dotta with email and PDFs to understand what\'s due next.' },
      { head:'Out of Scope', body:'Design interventions must work around this platform, not within it.' }
    ],
    goals:['Process applications','Store documentation','Track requirements'],
    channels:['Web platform'],
    x:-198, y:-162 },

  { id:'email-channel', label:'Email / PDF', sub:'Primary Comms Channel', cat:'channel', r:32,
    phases:['post-deposit'], scope:'out', power:40, interest:0, emotionalLoad:0,
    desc:'The dominant communication mode. Critical pre-departure information arrives by email and PDF. Students report very low retention — they can\'t retrieve information when they need it.',
    painPoints:[
      { head:'Email Overload', body:'Critical information buried in threads. Students can\'t track what\'s actionable.' },
      { head:'No Progressive Disclosure', body:'PDFs dump all information at once rather than surfacing it when contextually relevant.' }
    ],
    goals:['Deliver program information','Provide documentation guidance'],
    channels:['Email','PDF attachments'],
    x:192, y:-162 },

  { id:'canvas', label:'Canvas LMS', sub:'Academic Platform', cat:'channel', r:26,
    phases:['departure','post-abroad'], scope:'out', power:30, interest:0, emotionalLoad:0,
    desc:'Used primarily for academic coursework. Backstage during the critical pre-departure phase when withdrawals happen.',
    goals:['Deliver course content','Track academic progress'],
    channels:['Web platform'],
    x:368, y:-78 },

  { id:'exchange-sch', label:'Exchange School', sub:'Office of Intl Students', cat:'partner', r:38,
    phases:['application','post-deposit','departure','post-abroad'], scope:'out', power:70, interest:60, emotionalLoad:20,
    desc:'Partner universities managing incoming Pratt exchange students. Their deadlines and requirements add coordination load students must navigate with little OEA guidance.',
    painPoints:[{ head:'External Deadline Opacity', body:'Partner school requirements not clearly communicated through OEA, creating student anxiety.' }],
    goals:['Maintain bilateral exchange partnership','Integrate incoming exchange students'],
    channels:['Email','Partner portals','Direct OEA liaison'],
    x:-462, y:-58 },

  { id:'prof-foreign', label:'Professors / Faculty', sub:'From Exchange School', cat:'partner', r:30,
    phases:['departure','post-abroad'], scope:'out', power:40, interest:40, emotionalLoad:30,
    desc:'Faculty at partner institutions. Mostly active post-departure — limited influence on pre-departure withdrawal risk.',
    goals:['Teach exchange students effectively','Build international academic network'],
    channels:['Direct instruction','Email'],
    x:-500, y:122 },

  { id:'peers-abroad', label:'Peers Abroad', sub:'Local & Intl Students', cat:'partner', r:26,
    phases:['departure','post-abroad'], scope:'out', power:20, interest:30, emotionalLoad:50,
    desc:'Local and international students at partner schools. Informal but meaningful support network once abroad. No role in pre-departure retention.',
    goals:['Build international friendships','Cultural knowledge exchange'],
    channels:['Direct social interaction'],
    x:-482, y:252 },

  { id:'academic-adv', label:'Academic Advisor', sub:'Graduation Tracking', cat:'support', r:34,
    phases:['discovery','application','post-deposit'], scope:'in', power:65, interest:70, emotionalLoad:40,
    desc:'Critical but often backstage actor. Students need advisors to confirm abroad courses won\'t derail graduation — but access is slow and happens too late in the process.',
    painPoints:[
      { head:'Hidden Support System', body:'Advising support exists but isn\'t surfaced when students feel credit uncertainty.' },
      { head:'Late Intervention Risk', body:'Students sometimes reach post-deposit without understanding how abroad credits count.' }
    ],
    goals:['Ensure academic integrity of abroad experience','Track graduation pathway','Build student confidence'],
    channels:['In-person appointments','Email','One Pratt portal'],
    x:162, y:134 },

  { id:'fin-dept', label:'Financial Dept. Staff', sub:'Aid & Payments', cat:'support', r:32,
    phases:['application','post-deposit'], scope:'in', power:70, interest:55, emotionalLoad:30,
    desc:'Manages financial aid, tuition, scholarships, and payment schedules. Financial uncertainty is a top withdrawal driver — yet this department operates largely backstage from the student experience.',
    painPoints:[
      { head:'Financial Opacity', body:'Cost breakdown and payment schedules unclear even after deposit is paid. Students don\'t know total cost until deeply committed.' },
      { head:'Hidden Aid Resources', body:'Financial aid for study abroad exists but is not proactively surfaced during the decision phase.' }
    ],
    goals:['Process financial aid accurately','Provide payment clarity to students'],
    channels:['Terra Dotta','Email','In-person'],
    interventions:['Surface financial aid options early in discovery','Provide clear cost timeline before deposit'],
    x:-198, y:308 },

  { id:'geoblue', label:'GeoBlue Insurance', sub:'Emergency & Health', cat:'support', r:27,
    phases:['post-deposit','departure'], scope:'in', power:60, interest:20, emotionalLoad:10,
    desc:'Mandatory health insurance for study abroad. Enrollment is a required post-deposit step students often don\'t know about until late, adding to overwhelm.',
    painPoints:[{ head:'Surprise Mandatory Requirement', body:'Insurance enrollment isn\'t prominently communicated, adding unexpected burden post-deposit.' }],
    goals:['Provide student health coverage abroad','Process enrollment efficiently'],
    channels:['Online enrollment portal','Email'],
    x:-335, y:262 },

  { id:'mentors', label:'Profession Mentors', sub:'Career Support', cat:'support', r:27,
    phases:['post-deposit','departure','post-abroad'], scope:'in', power:30, interest:55, emotionalLoad:60,
    desc:'Career mentors who help students see the professional value of international experience. Emotional support role that sustains motivation through difficult logistics.',
    goals:['Connect experience to career outcomes','Provide motivational support'],
    channels:['Direct meetings','Email'],
    x:355, y:278 },

  { id:'student', label:'Outbound Student', sub:'Primary Actor', cat:'primary', r:54,
    phases:ALL, scope:'in', power:40, interest:95, emotionalLoad:95,
    desc:'The central actor the entire ecosystem must serve. Post-deposit, they face a coordination crisis: visa documents, financial payments, insurance enrollment, course approvals, and travel logistics arriving simultaneously — no clear sequence, no single guide, no progress visibility.',
    painPoints:[
      { head:'Coordination Overload', body:'Multiple simultaneous requirements with no unified task view. The student is the de-facto coordinator of a fragmented process.' },
      { head:'Information Fragmentation', body:'Required information distributed across Terra Dotta, email, PDF, Canvas, and word-of-mouth.' },
      { head:'Emotional Compounding', body:'Each unresolved question raises anxiety. Uncertainty about one thing (visa) bleeds into confidence about the whole decision.' },
      { head:'Financial Uncertainty', body:'After deposit, still unclear on total costs, aid availability, and payment deadlines.' },
      { head:'Invisible Support Systems', body:'Financial aid, advising, and insurance exist but are not surfaced at moments of highest uncertainty.' }
    ],
    goals:['Navigate pre-departure with confidence','Access support without friction','Feel academically and financially prepared'],
    channels:['Terra Dotta','Email','In-person','Word of mouth','Past students'],
    x:0, y:242 },

  { id:'parents', label:'Parents / Family', sub:'Emotional & Financial', cat:'student', r:32,
    phases:['discovery','application','post-deposit','departure'], scope:'in', power:50, interest:80, emotionalLoad:70,
    desc:'Family confidence in the process directly affects student decision-making. If family is also uncertain, withdrawal likelihood increases significantly.',
    painPoints:[{ head:'Second-order Anxiety', body:'Parents who don\'t understand costs and process reinforce student hesitation, especially around visa and financial uncertainty.' }],
    goals:['Ensure child safety and wellbeing','Understand the financial commitment','Validate the decision to go abroad'],
    channels:['Direct family communication'],
    x:-122, y:412 },

  { id:'past-student', label:'Past Students', sub:'Alumni Mentors', cat:'student', r:28,
    phases:['discovery','application','post-deposit'], scope:'in', power:25, interest:70, emotionalLoad:65,
    desc:'One of the highest-trust information sources for prospective students. Lived experience normalizes the process. Currently entirely informal and underutilized.',
    painPoints:[{ head:'Informal & Unstructured', body:'Knowledge shared ad hoc, not systematically channeled to prospective students at key decision points.' }],
    goals:['Help current students through shared experience','Stay connected to Pratt community'],
    channels:['Word of mouth','Social media'],
    interventions:['Formalize peer mentorship program in post-deposit phase'],
    x:122, y:412 },

  { id:'peers-out', label:'Peers / Other Outbound', sub:'Shared Journey', cat:'student', r:26,
    phases:['post-deposit','departure'], scope:'in', power:20, interest:75, emotionalLoad:65,
    desc:'Fellow students navigating the same process simultaneously. High mutual trust — can normalize confusion or amplify collective anxiety if no one has clear answers.',
    goals:['Share resources and information','Provide mutual emotional support'],
    channels:['Direct peer communication','Group chats'],
    x:258, y:388 },

  { id:'passport', label:'Passport Related', sub:'Documentation Risk', cat:'risk', r:32,
    phases:['post-deposit'], scope:'out', power:85, interest:0, emotionalLoad:0,
    desc:'Passport timelines and visa documentation are the #1 source of student confusion post-deposit. Requirements vary by destination and students have no single guide.',
    painPoints:[
      { head:'No Clear Timeline', body:'Students don\'t know when to start visa applications. Starting too late risks missing departure.' },
      { head:'Destination-Specific Opacity', body:'OEA communication doesn\'t clearly differentiate per-program requirements.' }
    ],
    goals:['Facilitate legal student entry to destination country'],
    channels:['Government portals','Consulate appointments','OEA guidance'],
    x:58, y:542 },

  { id:'flight', label:'Flight Related', sub:'Logistics Risk', cat:'risk', r:27,
    phases:['post-deposit','departure'], scope:'out', power:60, interest:0, emotionalLoad:0,
    desc:'Flight booking is tied to visa timeline. Students unsure whether to book before visa approval creates compounding risk.',
    painPoints:[{ head:'Visa-Flight Dependency', body:'OEA guidance on sequencing flight booking vs. visa approval is insufficient.' }],
    goals:['Enable student travel to destination'],
    channels:['Airline platforms','Travel tools'],
    x:215, y:534 },

  { id:'visa-dest', label:'Administration for Visa to Destination', sub:'Foreign Government', cat:'risk', r:34,
    phases:['post-deposit'], scope:'out', power:90, interest:0, emotionalLoad:0,
    desc:'Foreign government visa administration. Entirely outside OEA\'s control. Unpredictable processing times create anxiety that — without proactive support — leads to withdrawal.',
    painPoints:[{ head:'Uncontrollable External', body:'OEA can only help students prepare — cannot influence timelines or requirements.' }],
    goals:['Process student visa applications'],
    channels:['Consulate portals','In-person appointments'],
    x:-168, y:542 },

  { id:'intl-rel', label:'International Relations', sub:'Geopolitical Risk', cat:'risk', r:27,
    phases:ALL, scope:'out', power:85, interest:0, emotionalLoad:0,
    desc:'Geopolitical context — travel advisories, diplomatic relations, political instability — can invalidate program destinations. Entirely outside OEA control.',
    goals:['Maintain international student exchange frameworks'],
    channels:['Government policy','Institutional advisories'],
    x:-338, y:510 },
];

const EDGES = [
  { s:'pratt-admin', t:'pratt-oea',     flow:'authority', label:'Provide Resources & Budgets',           status:'healthy',  phases:ALL, w:1.6 },
  { s:'pratt-oea',   t:'pratt-admin',   flow:'info',      label:'Pay the department',                    status:'healthy',  phases:ALL, w:1 },
  { s:'pratt-admin', t:'terra-dotta',   flow:'authority', label:'Institutional platform constraint',      status:'strained', phases:ALL, w:1.2 },
  { s:'pratt-intl',  t:'pratt-oea',     flow:'task',      label:'International strategy coordination',    status:'healthy',  phases:ALL, w:1 },
  { s:'pratt-oea',   t:'oea-exchange',  flow:'authority', label:'Engage students & maintain programs',    status:'healthy',  phases:ALL, w:1.8 },
  { s:'pratt-oea',   t:'oea-faculty',   flow:'authority', label:'Manage faculty-led program',             status:'healthy',  phases:ALL, w:1.8 },
  { s:'pratt-oea',   t:'terra-dotta',   flow:'task',      label:'Publishes requirements & tracks apps',   status:'strained', phases:['application','post-deposit'], w:1.5 },
  { s:'pratt-oea',   t:'email-channel', flow:'info',      label:'Sends pre-departure guidance',           status:'broken',   phases:['post-deposit'], w:1.6, friction:'Critical info buried — students can\'t retain it' },
  { s:'oea-faculty', t:'email-channel', flow:'info',      label:'Program-specific updates',               status:'strained', phases:['post-deposit'], w:1.2, friction:'Inconsistent across faculty leaders' },
  { s:'terra-dotta',   t:'student', flow:'info',      label:'Application status & checklist',         status:'strained', phases:['application','post-deposit'], w:1.8, friction:'Fragmented — must cross-reference with email' },
  { s:'email-channel', t:'student', flow:'info',      label:'Critical pre-departure information',     status:'broken',   phases:['post-deposit'], w:1.8, friction:'High volume, low retention, no sequencing' },
  { s:'canvas',        t:'student', flow:'info',      label:'Academic coursework & content',          status:'healthy',  phases:['departure','post-abroad'], w:1 },
  { s:'oea-exchange', t:'oea-staff-ex', flow:'task', label:'Directs daily operations',         status:'healthy', phases:ALL, w:1 },
  { s:'oea-faculty',  t:'oea-staff-fl', flow:'task', label:'Directs daily operations',         status:'healthy', phases:ALL, w:1 },
  { s:'oea-faculty',  t:'faculty-prof', flow:'authority', label:'Program coordination',         status:'strained', phases:['post-deposit','departure'], w:1.5, friction:'Faculty absorbing admin tasks outside their role' },
  { s:'oea-staff-ex', t:'student', flow:'info',      label:'Application & logistics support',  status:'healthy',  phases:['application','post-deposit'], w:1.5 },
  { s:'oea-staff-fl', t:'student', flow:'info',      label:'Program & pre-departure support',  status:'strained', phases:['post-deposit'], w:1.5, friction:'Reactive — reached only when student is overwhelmed' },
  { s:'faculty-prof', t:'student', flow:'info',      label:'Program details & academic guidance', status:'strained', phases:['post-deposit','departure'], w:1.5, friction:'Inconsistent across faculty leaders' },
  { s:'faculty-prof', t:'student', flow:'emotional', label:'On-ground support while abroad',   status:'healthy',  phases:['departure'], w:1 },
  { s:'oea-exchange', t:'exchange-sch', flow:'task', label:'Maintain good relationships',       status:'healthy',  phases:['application','post-deposit'], w:1.6, bi:true },
  { s:'exchange-sch', t:'prof-foreign', flow:'authority', label:'Employs & directs faculty',   status:'healthy',  phases:['departure'], w:1 },
  { s:'prof-foreign', t:'student',  flow:'info',     label:'Unique courses & academic guidance', status:'healthy', phases:['departure','post-abroad'], w:1 },
  { s:'peers-abroad', t:'student',  flow:'emotional',label:'Cultural exchange & peer connection', status:'healthy', phases:['departure','post-abroad'], w:1 },
  { s:'academic-adv', t:'student',  flow:'info',     label:'Academic advice & graduation tracking', status:'strained', phases:['discovery','application','post-deposit'], w:1.6, friction:'Not surfaced at moment of student uncertainty' },
  { s:'fin-dept',     t:'student',  flow:'financial',label:'Financial Support',                  status:'broken',   phases:['application','post-deposit'], w:1.8, friction:'Financial opacity is top withdrawal driver' },
  { s:'geoblue',      t:'student',  flow:'task',     label:'Mandatory insurance enrollment',    status:'strained', phases:['post-deposit'], w:1.2, friction:'Surprise requirement adds to post-deposit overload' },
  { s:'mentors',      t:'student',  flow:'emotional',label:'Growth advice & motivation',        status:'healthy',  phases:['post-deposit','departure'], w:1 },
  { s:'pratt-admin',  t:'fin-dept', flow:'authority',label:'Budget & aid policy',               status:'healthy',  phases:ALL, w:1 },
  { s:'parents',    t:'student',  flow:'emotional', label:'Financial support & emotional support', status:'healthy', phases:['application','post-deposit','departure'], w:1.5, bi:true },
  { s:'past-student',t:'student', flow:'info',      label:'Advice / lived experience',           status:'healthy',  phases:['discovery','application','post-deposit'], w:1 },
  { s:'peers-out',  t:'student',  flow:'emotional', label:'Resources & emotional support',      status:'healthy',  phases:['post-deposit','departure'], w:1, bi:true },
  { s:'passport',  t:'student',   flow:'risk', label:'Visa confusion — #1 withdrawal driver',   status:'broken',   phases:['post-deposit'], w:2.2, risk:true, friction:'39% don\'t know what\'s required or when' },
  { s:'visa-dest', t:'student',   flow:'risk', label:'Unpredictable approval timeline',          status:'broken',   phases:['post-deposit'], w:1.8, risk:true },
  { s:'visa-dest', t:'passport',  flow:'risk', label:'Key document to visa approval route',      status:'healthy',  phases:['post-deposit'], w:1, risk:true },
  { s:'flight',    t:'student',   flow:'risk', label:'Timeline affecting departure date',        status:'strained', phases:['post-deposit'], w:1, risk:true },
  { s:'intl-rel',  t:'visa-dest', flow:'risk', label:'Policy influence on visa requirements',    status:'healthy',  phases:ALL, w:1, risk:true },
  { s:'intl-rel',  t:'student',   flow:'risk', label:'Geopolitical safety advisories',           status:'healthy',  phases:ALL, w:1, risk:true },
];

const PHASES_META = {
  all:           { label:'All Phases',                color:'#1A1A2E' },
  discovery:     { label:'Discovery Phase',           color:'#48A860' },
  application:   { label:'Application Phase',         color:'#5090C0' },
  'post-deposit':{ label:'⚠ Post-Deposit — Critical', color:'#D93030' },
  departure:     { label:'Departure Phase',           color:'#C8A020' },
  'post-abroad': { label:'Post-Abroad Phase',         color:'#5040A0' },
};

// ═══════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════
let xform = d3.zoomIdentity;
let activePhase = 'all', activeView = 'all', selectedId = null;

const byId = {};
NODES.forEach(n => byId[n.id] = n);

const svg   = d3.select('#g');
const groot = d3.select('#groot');

const zoom = d3.zoom().scaleExtent([0.08, 5])
  .on('zoom', e => { xform = e.transform; groot.attr('transform', e.transform); });

svg.call(zoom).on('dblclick.zoom', null);
svg.on('mousedown', () => svg.classed('dragging', true));
svg.on('mouseup mouseleave', () => svg.classed('dragging', false));

// ═══════════════════════════════════════════════════════
// FIT VIEW
// ═══════════════════════════════════════════════════════
function fitView(pad = 80) {
  const W = document.getElementById('cvs').clientWidth;
  const H = document.getElementById('cvs').clientHeight;
  const vis = NODES.filter(nodeVisible);
  if (!vis.length) return;
  const xs = vis.map(n => n.x), ys = vis.map(n => n.y);
  const x0 = Math.min(...xs)-110, x1 = Math.max(...xs)+110;
  const y0 = Math.min(...ys)-110, y1 = Math.max(...ys)+110;
  const sc = Math.min((W-pad*2)/(x1-x0), (H-pad*2)/(y1-y0), 1.35) * 0.83;
  const cx = (x0+x1)/2, cy = (y0+y1)/2;
  svg.transition().duration(720).ease(d3.easeCubicInOut)
    .call(zoom.transform, d3.zoomIdentity.translate(W/2-sc*cx, H/2-sc*cy).scale(sc));
}

// ═══════════════════════════════════════════════════════
// VISIBILITY
// ═══════════════════════════════════════════════════════
function nodeVisible(n) {
  if (activePhase !== 'all' && !n.phases.includes(activePhase)) return false;
  return true;
}
function edgeVisible(e) {
  if (activePhase !== 'all' && !(e.phases||[]).includes(activePhase)) return false;
  if (!byId[e.s] || !byId[e.t]) return false;
  if (!nodeVisible(byId[e.s]) || !nodeVisible(byId[e.t])) return false;
  if (activeView === 'friction') return e.status === 'broken' || e.status === 'strained';
  if (activeView !== 'all' && e.flow !== activeView) return false;
  return true;
}
function nodeOpacity(n) {
  if (!nodeVisible(n)) return 0.06;
  if (selectedId) {
    if (n.id === selectedId) return 1;
    const conn = EDGES.some(e => (e.s===selectedId&&e.t===n.id)||(e.t===selectedId&&e.s===n.id));
    return conn ? 1 : 0.11;
  }
  return 1;
}
function edgeOpacity(e) {
  if (!edgeVisible(e)) return 0;
  if (selectedId) return (e.s===selectedId||e.t===selectedId) ? 1 : 0.03;
  return e.risk ? 0.6 : 0.52;
}
function worstStatus(nodeId) {
  const ss = EDGES.filter(e => e.s===nodeId||e.t===nodeId).map(e => e.status);
  if (ss.includes('broken')) return 'broken';
  if (ss.includes('strained')) return 'strained';
  return 'healthy';
}

// ═══════════════════════════════════════════════════════
// RENDER
// ═══════════════════════════════════════════════════════
function render() {
  groot.selectAll('*').remove();

  // Group cluster ellipses
  if (!selectedId) {
    GROUPS.forEach(g => {
      const grp = groot.append('g');
      grp.append('ellipse')
        .attr('cx', g.cx).attr('cy', g.cy).attr('rx', g.rx).attr('ry', g.ry)
        .attr('fill', 'none').attr('stroke', '#AAAACC').attr('stroke-width', 1.5)
        .attr('stroke-dasharray', '10 5');
      const pw = g.label.length * 6.8 + 22;
      grp.append('rect')
        .attr('x', g.lx-pw/2).attr('y', g.ly-11).attr('width', pw).attr('height', 22)
        .attr('rx', 5).attr('fill', '#EDE8FA').attr('stroke', '#9C88D8').attr('stroke-width', 1);
      grp.append('text')
        .attr('x', g.lx).attr('y', g.ly+4.5)
        .attr('text-anchor', 'middle')
        .attr('font-family', 'Inter, sans-serif').attr('font-size', 10.5).attr('font-weight', 700)
        .attr('fill', '#5040A0').text(g.label);
    });
  }

  // Post-deposit danger zone overlay
  if (activePhase === 'post-deposit') {
    groot.append('ellipse')
      .attr('cx', 0).attr('cy', 178).attr('rx', 318).attr('ry', 196)
      .attr('fill', 'rgba(217,48,48,0.04)')
      .attr('stroke', 'rgba(217,48,48,0.22)').attr('stroke-width', 1.5)
      .attr('stroke-dasharray', '8 5');
  }

  // ── EDGES ─────────────────────────────────────────────
  const EG = groot.append('g');
  EDGES.forEach(e => {
    const sn = byId[e.s], tn = byId[e.t];
    if (!sn || !tn) return;
    const op = edgeOpacity(e);
    if (op < 0.01) return;

    const fc   = FLOW[e.flow]?.color || '#888';
    const isHL = selectedId && (e.s===selectedId||e.t===selectedId);
    const sw   = isHL ? (e.w||1)*2.2 : (e.w||1)*1.2;

    const dx = tn.x-sn.x, dy = tn.y-sn.y;
    const dist = Math.sqrt(dx*dx+dy*dy)||1;
    const curv = Math.min(42, dist*0.13);
    const px = -dy/dist*curv, py = dx/dist*curv;
    const mx = (sn.x+tn.x)/2+px, my = (sn.y+tn.y)/2+py;
    const sr = sn.r+3, tr = tn.r+3;
    const sx = sn.x+dx/dist*sr, sy = sn.y+dy/dist*sr;
    const ex = tn.x-dx/dist*tr, ey = tn.y-dy/dist*tr;
    const pathD = `M${sx},${sy} Q${mx},${my} ${ex},${ey}`;

    const eg = EG.append('g');

    const ln = eg.append('path').attr('d', pathD).attr('fill', 'none')
      .attr('stroke', fc).attr('stroke-width', sw)
      .attr('stroke-opacity', op).attr('stroke-linecap', 'round')
      .attr('stroke-dasharray', e.risk ? '8,5' : 'none')
      .attr('marker-end', op>0.02 ? `url(#arr-${isHL?e.flow+'-hi':e.flow})` : 'none');

    if (e.risk && isHL) ln.classed('dash-anim', true).attr('stroke-dasharray', '8,5');

    if (e.bi && op > 0.02) {
      eg.append('path').attr('d', `M${ex},${ey} Q${mx},${my} ${sx},${sy}`)
        .attr('fill', 'none').attr('stroke', fc)
        .attr('stroke-width', sw*0.65).attr('stroke-opacity', op*0.45)
        .attr('stroke-linecap', 'round').attr('marker-end', `url(#arr-${e.flow})`);
    }

    // Edge label — always visible, bolder text
    if (e.label && op > 0.35) {
      const t = 0.5;
      const bx = (1-t)*(1-t)*sx + 2*(1-t)*t*mx + t*t*ex;
      const by = (1-t)*(1-t)*sy + 2*(1-t)*t*my + t*t*ey;
      const lc = e.status==='broken' ? '#B01010' : e.status==='strained' ? '#906010' : '#404060';
      const lw = Math.min(e.label.length * 5.8 + 12, 138);
      eg.append('rect')
        .attr('x', bx-lw/2).attr('y', by-8).attr('width', lw).attr('height', 14)
        .attr('rx', 3).attr('fill', 'white').attr('opacity', isHL ? 0.97 : 0.82);
      eg.append('text').attr('x', bx).attr('y', by+4)
        .attr('text-anchor', 'middle')
        .attr('font-family', 'Inter, sans-serif')
        .attr('font-size', isHL ? 9 : 8).attr('font-weight', isHL ? 700 : 600)
        .attr('fill', lc)
        .text(e.label.length > 30 ? e.label.slice(0,29)+'…' : e.label);
    }
  });

  // ── NODES ─────────────────────────────────────────────
  const NG = groot.append('g');
  const tt   = document.getElementById('tt');
  const ttN  = document.getElementById('tt-name');
  const ttS  = document.getElementById('tt-sub');
  const ttSt = document.getElementById('tt-st');

  NODES.forEach(n => {
    const cat   = CAT[n.cat];
    const op    = nodeOpacity(n);
    const isSel = n.id === selectedId;
    const isConn = selectedId && !isSel && EDGES.some(e=>(e.s===selectedId&&e.t===n.id)||(e.t===selectedId&&e.s===n.id));
    const ws    = worstStatus(n.id);

    const g = NG.append('g')
      .attr('transform', `translate(${n.x},${n.y})`)
      .attr('opacity', op)
      .style('cursor', nodeVisible(n) ? 'pointer' : 'default');

    // Pulse for key nodes
    if ((n.id==='pratt-oea'||n.id==='student') && op>0.5 && !isSel) {
      g.append('circle').attr('r', n.r+15).attr('fill', 'none')
        .attr('stroke', cat.stroke).attr('stroke-width', 2)
        .classed('pulse-el', true).attr('opacity', 0.3);
    }

    // Selection ring
    if (isSel) {
      g.append('circle').attr('r', n.r+14).attr('fill', cat.fill).attr('opacity', 0.14);
      g.append('circle').attr('r', n.r+9).attr('fill', 'none')
        .attr('stroke', cat.stroke).attr('stroke-width', 3.5).attr('opacity', 1);
    }

    // Connected dashed ring
    if (isConn) {
      g.append('circle').attr('r', n.r+8).attr('fill', 'none')
        .attr('stroke', cat.stroke).attr('stroke-width', 2)
        .attr('opacity', 0.5).attr('stroke-dasharray', '4 3');
    }

    // Friction status ring
    if (ws === 'broken' && !isSel) {
      g.append('circle').attr('r', n.r+7).attr('fill', 'none')
        .attr('stroke', '#D93030').attr('stroke-width', 2.5)
        .attr('opacity', 0.55).attr('stroke-dasharray', '5 3').classed('dash-anim', true);
    } else if (ws === 'strained' && !isSel) {
      g.append('circle').attr('r', n.r+6).attr('fill', 'none')
        .attr('stroke', '#D48020').attr('stroke-width', 2).attr('opacity', 0.42);
    }

    // Main circle
    if (cat.dashed) {
      g.append('circle').attr('r', n.r)
        .attr('fill', '#FFFFFF').attr('stroke', '#D93030')
        .attr('stroke-width', 3).attr('stroke-dasharray', '7 4');
    } else {
      g.append('circle').attr('r', n.r)
        .attr('fill', cat.fill).attr('stroke', cat.stroke).attr('stroke-width', 2.5);
    }

    // ── NODE LABELS — much larger font, bold ───────────────
    // Font scale: r * 0.28 (significantly larger than before)
    const words = n.label.split(' ');
    const fs = Math.max(8.5, Math.min(13.5, n.r * 0.285));
    const charsPerLine = Math.max(5, Math.floor(n.r * 0.38));
    const lines = wrapText(words, charsPerLine);
    const lh = fs * 1.3;
    const hasSub = n.sub && n.r >= 32;
    const totalH = lines.length * lh;
    let baseY = -totalH/2 + lh*0.4;
    if (hasSub) baseY -= fs * 0.48;

    lines.forEach((line, i) => {
      const maxW = (n.r - 7) * 2;
      const approxW = line.length * fs * 0.6;
      const disp = approxW > maxW ? clipW(line, maxW, fs) : line;
      g.append('text')
        .attr('y', baseY + i*lh)
        .attr('text-anchor', 'middle')
        .attr('font-family', 'Inter, sans-serif')
        .attr('font-size', fs)
        .attr('font-weight', 800)           // ← heavier weight
        .attr('fill', cat.text)
        .text(disp);
    });

    if (hasSub) {
      const sf = Math.max(7, fs * 0.68);
      const subT = n.sub.length > 24 ? n.sub.slice(0,23)+'…' : n.sub;
      g.append('text')
        .attr('y', baseY + totalH + sf*0.7)
        .attr('text-anchor', 'middle')
        .attr('font-family', 'Inter, sans-serif')
        .attr('font-size', sf).attr('font-weight', 500)
        .attr('fill', cat.text).attr('opacity', cat.dashed ? 0.65 : 0.58)
        .text(subT);
    }

    // Events
    g.on('mouseenter', ev => {
      if (n.id === selectedId) return;
      ttN.textContent = n.label;
      ttS.textContent = n.sub || '';
      const w = worstStatus(n.id);
      if (w==='broken')   { ttSt.textContent='⚠ Broken relationship'; ttSt.style.cssText='background:rgba(217,48,48,0.2);color:#FF8080;padding:2px 8px;border-radius:4px;'; }
      else if (w==='strained') { ttSt.textContent='~ Strained relationship'; ttSt.style.cssText='background:rgba(212,128,32,0.2);color:#FFA040;padding:2px 8px;border-radius:4px;'; }
      else { ttSt.textContent=''; ttSt.style.cssText=''; }
      tt.classList.add('show');
    })
    .on('mousemove', ev => { tt.style.left=(ev.clientX+14)+'px'; tt.style.top=(ev.clientY-14)+'px'; })
    .on('mouseleave', () => tt.classList.remove('show'))
    .on('click', ev => {
      ev.stopPropagation();
      tt.classList.remove('show');
      if (!nodeVisible(n)) return;
      selectedId = (selectedId===n.id) ? null : n.id;
      selectedId ? populateSidebar(n) : clearSidebar();
      render();
    });
  });

  svg.on('click', ev => {
    if (ev.target===svg.node()||ev.target.tagName==='svg') {
      selectedId=null; clearSidebar(); render();
    }
  });
}

function wrapText(words, cpl) {
  if (!words.length) return [''];
  const lines = []; let cur = '';
  words.forEach(w => {
    const t = cur ? cur+' '+w : w;
    if (t.length <= cpl) cur = t;
    else { if (cur) lines.push(cur); cur = w; }
  });
  if (cur) lines.push(cur);
  return lines.length ? lines : [words.join(' ')];
}
function clipW(text, maxW, fs) {
  const mc = Math.floor(maxW / (fs * 0.6));
  return text.length > mc ? text.slice(0, mc-1)+'…' : text;
}

// ═══════════════════════════════════════════════════════
// SIDEBAR
// ═══════════════════════════════════════════════════════
function clearSidebar() {
  document.getElementById('sb-kicker').textContent = 'Stakeholder Detail';
  document.getElementById('sb-title').textContent  = 'Click any node';
  document.getElementById('sb-body').innerHTML = `
    <div class="sb-empty">
      <div class="sb-empty-icon">◉</div>
      <div class="sb-empty-hint">Click any node to explore</div>
      <div class="sb-empty-desc">See goals, friction points, value flows, and design interventions for each stakeholder.</div>
    </div>`;
}

function populateSidebar(n) {
  const cat = CAT[n.cat];
  const ws  = worstStatus(n.id);
  const outE = EDGES.filter(e => e.s===n.id && edgeVisible(e));
  const inE  = EDGES.filter(e => e.t===n.id && edgeVisible(e));
  const connIds = new Set([...outE.map(e=>e.t), ...inE.map(e=>e.s)]);

  document.getElementById('sb-kicker').textContent = cat.label.toUpperCase();
  document.getElementById('sb-title').textContent  = n.label;

  const scopeTag = n.scope==='in'
    ? `<span class="stag inscope">🎯 In Scope</span>`
    : `<span class="stag outscope">⊘ Out of Scope</span>`;
  const wsTag = ws==='broken' ? `<span class="stag broken">⚠ Broken</span>`
    : ws==='strained' ? `<span class="stag strained">~ Strained</span>`
    : `<span class="stag healthy">✓ Functioning</span>`;

  let h = `<div class="sb-ani">`;

  // Identity
  h += `<div class="sbs">
    <div class="node-badge" style="background:${n.cat==='risk'?'rgba(217,48,48,0.08)':cat.fill+'22'};color:${n.cat==='risk'?'#C02020':cat.stroke};border:1.5px solid ${n.cat==='risk'?'rgba(217,48,48,0.3)':cat.stroke+'44'};">
      <span style="width:8px;height:8px;border-radius:50%;background:${n.cat==='risk'?'white':cat.fill};border:${n.cat==='risk'?'2px dashed #D93030':'none'};display:inline-block;flex-shrink:0;"></span>
      ${cat.label}
    </div>
    <p class="sb-desc">${n.desc}</p>
    <div class="status-row">${wsTag}${scopeTag}</div>
  </div>`;

  // Profile meters
  h += `<div class="sbs">
    <div class="sbs-head">Profile</div>
    <div class="inf-bar">
      ${ir('Power',n.power,cat.stroke)}
      ${ir('Interest',n.interest,cat.stroke)}
      ${ir('Emotional Load',n.emotionalLoad,cat.stroke)}
      ${ir('Connections',Math.min(100,connIds.size*13),cat.stroke,connIds.size)}
    </div>
  </div>`;

  if (n.goals?.length) {
    h += `<div class="sbs"><div class="sbs-head">Goals <span class="sbs-count">${n.goals.length}</span></div><div class="goal-list">`;
    n.goals.forEach(g => h += `<div class="goal-item"><div class="goal-dot" style="background:${cat.stroke}"></div><span>${g}</span></div>`);
    h += `</div></div>`;
  }

  if (n.painPoints?.length) {
    h += `<div class="sbs"><div class="sbs-head" style="color:var(--broken)">⚠ Friction Points <span class="sbs-count">${n.painPoints.length}</span></div>`;
    n.painPoints.forEach(p => h += `<div class="pain-card"><div class="pain-head">⬤ ${p.head}</div>${p.body}</div>`);
    h += `</div>`;
  }

  if (n.interventions?.length) {
    h += `<div class="sbs"><div class="sbs-head" style="color:#2A7040">💡 Interventions</div>`;
    n.interventions.forEach(iv => {
      const [title,...rest] = iv.split(':');
      h += `<div class="int-card"><div class="int-head">→ ${title}</div><div class="int-body">${rest.join(':')}</div></div>`;
    });
    h += `</div>`;
  }

  if (n.channels?.length) {
    const cm = {'Terra Dotta':['rgba(80,144,192,0.12)','#2060A0'],'Email':['rgba(217,48,48,0.10)','#A01010'],'Canvas':['rgba(72,168,96,0.10)','#287840']};
    h += `<div class="sbs"><div class="sbs-head">Channels</div><div class="ch-wrap">`;
    n.channels.forEach(c => {
      const [bg,fg] = cm[c]||['rgba(0,0,0,0.05)','var(--muted)'];
      h += `<span class="ch-pill" style="background:${bg};color:${fg};">${c}</span>`;
    });
    h += `</div></div>`;
  }

  if (outE.length) {
    h += `<div class="sbs"><div class="sbs-head">Sends <span class="sbs-count">${outE.length}</span></div><div class="flow-list">`;
    outE.forEach(e => h += mkCard(e, byId[e.t], '→'));
    h += `</div></div>`;
  }

  if (inE.length) {
    h += `<div class="sbs"><div class="sbs-head">Receives <span class="sbs-count">${inE.length}</span></div><div class="flow-list">`;
    inE.forEach(e => h += mkCard(e, byId[e.s], '←'));
    h += `</div></div>`;
  }

  if (connIds.size) {
    h += `<div class="sbs"><div class="sbs-head">Connected Nodes <span class="sbs-count">${connIds.size}</span></div><div class="conn-wrap">`;
    connIds.forEach(id => {
      const cn = byId[id]; if (!cn) return;
      const cc = CAT[cn.cat];
      h += `<span class="conn-chip" data-id="${id}" style="border-color:${cc.stroke}66;color:${cc.stroke};">${cn.label}</span>`;
    });
    h += `</div></div>`;
  }

  h += `</div>`;
  document.getElementById('sb-body').innerHTML = h;
  document.querySelectorAll('.conn-chip[data-id]').forEach(c => c.addEventListener('click', () => jumpTo(c.dataset.id)));
  document.querySelectorAll('.flow-card[data-id]').forEach(c => c.addEventListener('click', () => jumpTo(c.dataset.id)));
}

function jumpTo(id) {
  const node = byId[id]; if (!node) return;
  selectedId = id; populateSidebar(node); render();
  const W = document.getElementById('cvs').clientWidth, H = document.getElementById('cvs').clientHeight;
  svg.transition().duration(500).ease(d3.easeCubicInOut)
    .call(zoom.transform, d3.zoomIdentity.translate(W/2-xform.k*node.x, H/2-xform.k*node.y).scale(xform.k));
}

function ir(label, val, color, disp) {
  return `<div class="inf-row">
    <span class="inf-lbl">${label}</span>
    <div class="inf-track"><div class="inf-fill" style="width:${Math.min(100,val)}%;background:${color}"></div></div>
    <span class="inf-val">${disp!==undefined?disp:val}</span>
  </div>`;
}

function mkCard(edge, other, dir) {
  if (!other) return '';
  const fc = FLOW[edge.flow]?.color || '#888';
  const stCls = edge.status==='broken'?'broken':edge.status==='strained'?'strained':'healthy';
  const stLbl = edge.status==='broken'?'✕ Broken':edge.status==='strained'?'~ Strained':'✓ Healthy';
  return `<div class="flow-card" data-id="${other.id}">
    <div class="flow-dot" style="background:${fc}"></div>
    <div class="flow-inner">
      <div class="flow-dir">${FLOW[edge.flow]?.label||edge.flow} ${dir} ${other.label}</div>
      <div class="flow-lbl">${edge.label}</div>
      ${edge.friction?`<div class="flow-status ${stCls}">${stLbl}: ${edge.friction}</div>`:`<div class="flow-status ${stCls}">${stLbl}</div>`}
    </div>
  </div>`;
}

// ═══════════════════════════════════════════════════════
// CONTROLS
// ═══════════════════════════════════════════════════════
document.getElementById('zi').onclick = () => svg.transition().duration(240).call(zoom.scaleBy, 1.3);
document.getElementById('zo').onclick = () => svg.transition().duration(240).call(zoom.scaleBy, 0.77);
document.getElementById('zf').onclick = () => fitView();

document.getElementById('panel-btn').onclick = function() {
  const sb = document.getElementById('sidebar');
  sb.classList.toggle('closed');
  this.classList.toggle('active');
};

document.querySelectorAll('.phase-pill').forEach(btn => btn.addEventListener('click', () => {
  activePhase = btn.dataset.phase;
  document.querySelectorAll('.phase-pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  selectedId = null; clearSidebar();

  const pb  = document.getElementById('phase-banner');
  const pbd = document.getElementById('pb-dot');
  const pbt = document.getElementById('pb-text');
  if (activePhase !== 'all') {
    const pm = PHASES_META[activePhase];
    pbd.style.background = pm.color;
    pbt.textContent = pm.label;
    pb.classList.add('show');
  } else pb.classList.remove('show');

  render();
  requestAnimationFrame(() => fitView());
}));

document.querySelectorAll('.vbtn[data-view]').forEach(btn => btn.addEventListener('click', () => {
  activeView = btn.dataset.view;
  document.querySelectorAll('.vbtn[data-view]').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  render();
}));

window.addEventListener('resize', render);

render();
requestAnimationFrame(() => requestAnimationFrame(() => fitView()));
</script>
</body>
</html>
