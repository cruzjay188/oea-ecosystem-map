<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Service Ecosystem Map Â· Pratt OEA</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=Lora:ital,wght@0,500;0,700;1,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<style>
:root {
  --ink:       #141418;
  --ink2:      #3A3A46;
  --muted:     #8A8A9A;
  --border:    rgba(0,0,0,0.08);
  --bg:        #F1EFE9;
  --surface:   #FFFFFF;
  --glass:     rgba(255,255,255,0.9);
  --oea:       #D4A843;
  --admin:     #7C6FCD;
  --channel:   #3A9CC8;
  --partner:   #7A8C6E;
  --financial: #C4785A;
  --student:   #C4956A;
  --risk:      #C05050;
  --flow-info:      #4A9EC4;
  --flow-financial: #E8A040;
  --flow-emotional: #C46090;
  --flow-authority: #7C6FCD;
  --flow-task:      #6EB88A;
  --broken:  #E05050;
  --strained:#E8A040;
  --healthy: #5AB870;
  --sidebar-w: 340px;
}
*,*::before,*::after { box-sizing:border-box; margin:0; padding:0; }
html,body { height:100%; overflow:hidden; }
body { background:var(--bg); color:var(--ink); font-family:'Sora',sans-serif; font-size:13px; display:flex; flex-direction:column; }

/* â”€â”€ HEADER: two rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#header {
  display: flex; flex-direction: column;
  flex-shrink: 0;
  z-index: 400;
  box-shadow: 0 2px 18px rgba(0,0,0,0.10);
}

/* Row 1 â€” TITLE (dark, prominent) */
#title-row {
  background: var(--ink);
  display: flex; align-items: center;
  padding: 11px 20px;
  gap: 0;
  border-bottom: 2px solid var(--oea);
}
.logo-badge {
  width: 32px; height: 32px; border-radius: 7px;
  background: var(--oea);
  display: flex; align-items: center; justify-content: center;
  font-family: 'Lora', serif; font-size: 14px; font-weight: 700;
  color: var(--ink); flex-shrink: 0; margin-right: 14px;
}
.title-group { flex:1; min-width:0; }
.title-main {
  font-family: 'Lora', serif;
  font-size: 17px; font-weight: 700;
  letter-spacing: -0.025em; line-height: 1.15;
  color: #FFFFFF;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.title-main em { font-style: italic; color: var(--oea); }
.title-sub {
  font-size: 10px; color: rgba(255,255,255,0.42);
  margin-top: 2px; white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis;
  letter-spacing: 0.01em;
}
.title-divider { width:1px; height:30px; background:rgba(255,255,255,0.12); margin:0 18px; flex-shrink:0; }
.title-stats { display:flex; gap:8px; flex-shrink:0; }
.ts-chip {
  display: flex; flex-direction: column; align-items: flex-start;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.13);
  border-radius: 8px; padding: 5px 11px;
}
.ts-chip .tv { font-family:'Lora',serif; font-size:13px; font-weight:700; color:#FFF; line-height:1; }
.ts-chip .tl { font-size:8px; font-weight:700; text-transform:uppercase; letter-spacing:0.09em; color:rgba(255,255,255,0.4); margin-top:2px; }
.ts-chip.alert .tv { color:#FF9090; }

/* Row 2 â€” CONTROLS (light) */
#controls-row {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center;
  padding: 0 20px; height: 42px; gap: 10px;
}
.phase-bar {
  display: flex; align-items: center; gap: 2px;
  background: var(--bg); border: 1px solid var(--border);
  border-radius: 20px; padding: 3px 4px; flex-shrink:0;
}
.phase-pill {
  padding: 3px 10px; border-radius: 14px;
  font-size: 10.5px; font-weight: 500;
  cursor: pointer; color: var(--muted);
  border: none; background: transparent;
  font-family: 'Sora', sans-serif; white-space: nowrap;
  transition: all .15s;
}
.phase-pill:hover { color:var(--ink); }
.phase-pill.active { background:var(--ink); color:#FFF; font-weight:600; }
.phase-pill.crit.active { background: var(--risk); }
.ctrl-div { width:1px; height:20px; background:var(--border); flex-shrink:0; }
.view-set { display:flex; gap:3px; flex-shrink:0; }
.vbtn {
  height:28px; padding:0 10px; border-radius:6px;
  border: 1px solid var(--border); background: transparent;
  font-family:'Sora',sans-serif; font-size:10.5px; font-weight:500;
  color:var(--muted); cursor:pointer; white-space:nowrap;
  transition: all .14s;
}
.vbtn:hover { color:var(--ink); border-color:rgba(0,0,0,0.16); }
.vbtn.active { background:var(--ink); color:#FFF; border-color:var(--ink); }
.search-box {
  display:flex; align-items:center; gap:6px;
  background:var(--bg); border:1px solid var(--border);
  border-radius:7px; padding:5px 10px; width:180px;
  transition: border-color .14s;
}
.search-box:focus-within { border-color:var(--ink); }
.search-box input { border:none; background:none; outline:none; font-family:'Sora',sans-serif; font-size:11px; color:var(--ink); width:100%; }
.search-box input::placeholder { color:var(--muted); }
.panel-btn { margin-left:auto; }

/* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#main { flex:1; display:flex; overflow:hidden; }
#cvs { flex:1; position:relative; overflow:hidden; }
svg#g { width:100%; height:100%; cursor:grab; }
svg#g.dragging { cursor:grabbing; }

/* â”€â”€ FLOATING UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* Scope tags â€” top left */
#scope-strip {
  position:absolute; top:14px; left:16px; z-index:200;
  display:flex; flex-direction:column; gap:5px;
}
.scope-tag {
  padding:4px 10px; border-radius:20px;
  font-size:9.5px; font-weight:600; letter-spacing:0.04em;
  backdrop-filter: blur(8px);
}
.scope-in  { background:rgba(90,184,112,0.14); color:#3A8A52; border:1px solid rgba(90,184,112,0.28); }
.scope-out { background:rgba(138,138,154,0.10); color:var(--muted); border:1px solid var(--border); }

/* Phase active badge â€” top right */
#phase-badge {
  position:absolute; top:14px; right:16px; z-index:200;
  display:flex; align-items:center; gap:7px;
  background:var(--glass); backdrop-filter:blur(14px);
  border:1px solid var(--border); border-radius:20px;
  padding:5px 13px 5px 9px;
  font-size:11px; font-weight:600;
  box-shadow:0 2px 10px rgba(0,0,0,0.06);
  opacity:0; transition:opacity .25s; pointer-events:none;
}
#phase-badge.visible { opacity:1; }
#phase-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }

/* Legend â€” bottom left */
#legend {
  position:absolute; bottom:16px; left:16px; z-index:200;
  width:196px;
  background:var(--glass); backdrop-filter:blur(18px);
  border:1px solid var(--border); border-radius:12px;
  padding:13px 14px;
  box-shadow:0 4px 20px rgba(0,0,0,0.08);
}
.leg-sec { margin-bottom:10px; }
.leg-sec:last-child { margin-bottom:0; }
.leg-head { font-size:9px; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:var(--muted); margin-bottom:6px; }
.leg-row { display:flex; align-items:center; gap:7px; padding:2px 4px; border-radius:5px; margin-bottom:1px; cursor:pointer; transition:background .13s; }
.leg-row:hover { background:rgba(0,0,0,0.04); }
.leg-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.leg-line { width:20px; height:3px; border-radius:2px; flex-shrink:0; }
.leg-line.dashed { background:none !important; border-top:2.5px dashed var(--risk); height:0; margin-top:1px; }
.leg-lbl { font-size:10px; color:var(--ink2); }

/* Zoom â€” bottom right */
#zoom-wrap {
  position:absolute; bottom:16px; right:16px; z-index:200;
  display:flex; flex-direction:column; gap:4px;
}
.zbtn {
  width:32px; height:32px; border-radius:7px;
  border:1px solid var(--border); background:var(--glass);
  backdrop-filter:blur(10px); color:var(--ink);
  font-size:15px; font-weight:300; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 2px 8px rgba(0,0,0,0.07); transition:all .13s;
}
.zbtn:hover { background:var(--ink); color:#FFF; border-color:var(--ink); }

/* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  width:var(--sidebar-w); background:var(--surface);
  border-left:1px solid var(--border);
  display:flex; flex-direction:column; overflow:hidden;
  transition:width .26s cubic-bezier(.4,0,.2,1);
  flex-shrink:0; box-shadow:-2px 0 16px rgba(0,0,0,0.05);
}
#sidebar.closed { width:0; }
.sb-head { padding:16px 18px 13px; border-bottom:1px solid var(--border); flex-shrink:0; }
.sb-kicker { font-size:9px; font-weight:700; letter-spacing:0.12em; text-transform:uppercase; color:var(--muted); margin-bottom:4px; }
.sb-title { font-family:'Lora',serif; font-size:15px; font-weight:700; color:var(--ink); line-height:1.25; }
.sb-body { flex:1; overflow-y:auto; }
.sb-body::-webkit-scrollbar { width:3px; }
.sb-body::-webkit-scrollbar-thumb { background:rgba(0,0,0,0.1); border-radius:2px; }

.sb-empty { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; padding:28px 22px; text-align:center; gap:12px; }
.sb-empty-icon { font-size:2.4rem; opacity:0.18; }
.sb-empty-title { font-family:'Lora',serif; font-size:14px; color:var(--ink2); }
.sb-empty-desc { font-size:11px; color:var(--muted); line-height:1.65; }

/* Sidebar sections */
.sbs { padding:14px 18px; border-bottom:1px solid var(--border); }
.sbs:last-child { border-bottom:none; }
.sbs-head {
  font-size:9px; font-weight:700; letter-spacing:0.1em; text-transform:uppercase;
  color:var(--muted); margin-bottom:9px;
  display:flex; align-items:center; justify-content:space-between;
}
.sbs-count { background:var(--bg); border-radius:9px; padding:1px 7px; font-size:9px; font-weight:600; color:var(--muted); }
.node-badge { display:inline-flex; align-items:center; gap:5px; padding:4px 10px; border-radius:20px; font-size:9.5px; font-weight:700; letter-spacing:0.06em; text-transform:uppercase; margin-bottom:9px; }
.sb-desc { font-size:11.5px; line-height:1.7; color:var(--ink2); }
.status-row { display:flex; gap:6px; flex-wrap:wrap; margin-top:10px; }
.stag { display:inline-flex; align-items:center; gap:4px; padding:3px 9px; border-radius:20px; font-size:9.5px; font-weight:600; border:1.5px solid; }
.stag.broken   { color:var(--broken);  border-color:rgba(192,80,80,0.3);  background:rgba(192,80,80,0.06); }
.stag.strained { color:var(--strained);border-color:rgba(232,160,64,0.3); background:rgba(232,160,64,0.06); }
.stag.healthy  { color:var(--healthy); border-color:rgba(90,184,112,0.3); background:rgba(90,184,112,0.06); }
.stag.inscope  { color:#3A8A52; border-color:rgba(90,184,112,0.3); background:rgba(90,184,112,0.06); }
.stag.outscope { color:var(--muted); border-color:var(--border); background:var(--bg); }

.inf-bar { display:flex; flex-direction:column; gap:7px; margin-top:8px; }
.inf-row { display:flex; align-items:center; gap:8px; }
.inf-lbl { width:88px; font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:0.05em; color:var(--muted); flex-shrink:0; }
.inf-track { flex:1; height:4px; background:var(--bg); border-radius:3px; overflow:hidden; min-width:40px; }
.inf-fill { height:100%; border-radius:3px; transition:width .45s .1s; }
.inf-val { width:26px; text-align:right; font-size:10px; font-weight:700; color:var(--ink); flex-shrink:0; }

.goal-list { display:flex; flex-direction:column; gap:6px; }
.goal-item { display:flex; align-items:flex-start; gap:8px; font-size:11px; line-height:1.55; color:var(--ink2); }
.goal-dot { width:5px; height:5px; border-radius:50%; margin-top:5px; flex-shrink:0; }

.pain-card { background:rgba(192,80,80,0.05); border:1px solid rgba(192,80,80,0.18); border-radius:8px; padding:10px 12px; margin-bottom:7px; font-size:11px; line-height:1.6; color:var(--ink2); word-break:break-word; }
.pain-head { font-weight:700; color:var(--broken); font-size:10.5px; margin-bottom:4px; }

.int-card { background:rgba(90,184,112,0.06); border:1px solid rgba(90,184,112,0.22); border-radius:8px; padding:10px 12px; margin-bottom:7px; word-break:break-word; }
.int-head { font-weight:700; font-size:11px; color:#2E7A46; margin-bottom:3px; }
.int-body { font-size:10.5px; color:var(--ink2); line-height:1.55; }

.ch-wrap { display:flex; flex-wrap:wrap; gap:5px; }
.ch-pill { padding:4px 9px; border-radius:6px; font-size:9.5px; font-weight:600; display:flex; align-items:center; gap:4px; white-space:nowrap; }

.flow-list { display:flex; flex-direction:column; gap:6px; }
.flow-card {
  display:flex; gap:9px; background:var(--bg);
  border-radius:8px; padding:9px 11px; cursor:pointer;
  border:1px solid transparent; transition:all .13s; min-width:0;
}
.flow-card:hover { border-color:var(--border); background:white; }
.flow-dot { width:7px; height:7px; border-radius:50%; margin-top:5px; flex-shrink:0; }
.flow-inner { flex:1; min-width:0; overflow:hidden; }
.flow-dir { font-size:9px; font-weight:700; letter-spacing:0.07em; text-transform:uppercase; color:var(--muted); margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.flow-lbl { font-size:11px; color:var(--ink); line-height:1.4; font-weight:500; word-break:break-word; }
.flow-ch  { margin-top:3px; font-size:9.5px; color:var(--muted); display:flex; align-items:center; gap:3px; }
.flow-status { margin-top:4px; padding:2px 7px; border-radius:4px; font-size:9px; font-weight:700; display:inline-block; word-break:break-word; line-height:1.5; }
.flow-status.broken   { background:rgba(192,80,80,0.09);  color:var(--broken); }
.flow-status.strained { background:rgba(232,160,64,0.09); color:var(--strained); }
.flow-status.healthy  { background:rgba(90,184,112,0.09); color:var(--healthy); }

.conn-wrap { display:flex; flex-wrap:wrap; gap:5px; }
.conn-chip { padding:4px 10px; border-radius:20px; font-size:10px; font-weight:500; cursor:pointer; border:1.5px solid; background:white; transition:all .13s; }
.conn-chip:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,0.09); }

/* â”€â”€ TOOLTIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#tt {
  position:fixed; z-index:999; pointer-events:none;
  opacity:0; transition:opacity .1s;
  background:rgba(18,18,22,0.94); backdrop-filter:blur(10px);
  color:#EEE; padding:8px 12px; border-radius:8px;
  max-width:210px; font-size:11.5px; line-height:1.4;
  box-shadow:0 8px 24px rgba(0,0,0,0.22);
}
#tt.show { opacity:1; }
.tt-name { font-weight:700; }
.tt-sub  { font-size:10px; opacity:0.55; margin-top:2px; }
.tt-st   { margin-top:5px; font-size:9.5px; font-weight:700; padding:2px 7px; border-radius:4px; display:inline-block; }

@keyframes dash-anim { to { stroke-dashoffset:-20; } }
@keyframes pulse-anim { 0%,100%{opacity:.35;transform:scale(1)} 50%{opacity:.12;transform:scale(1.1)} }
.pulse-ring { animation: pulse-anim 3s ease-in-out infinite; transform-origin:center; }
.flow-anim  { animation: dash-anim 1.2s linear infinite; }
@keyframes sb-in { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
.sb-ani { animation: sb-in .2s ease forwards; }
</style>
</head>
<body>

<!-- â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="header">

  <!-- Row 1: Title â€” what a hiring manager reads first -->
  <div id="title-row">
    <div class="logo-badge">P</div>
    <div class="title-group">
      <div class="title-main">Service Ecosystem Map &nbsp;Â·&nbsp; <em>Mitigating Student Withdrawals in Study Abroad</em></div>
      <div class="title-sub">Pratt Institute Â· Office of Education Abroad Â· Service Design Â· Jeffrey Delacruz, Ariel, Shreya Â· Novâ€“Dec 2025</div>
    </div>
    <div class="title-divider"></div>
    <div class="title-stats">
      <div class="ts-chip alert"><span class="tv">39.28%</span><span class="tl">Withdrawal Rate</span></div>
      <div class="ts-chip"><span class="tv">26</span><span class="tl">Stakeholders</span></div>
      <div class="ts-chip"><span class="tv">5</span><span class="tl">Friction Points</span></div>
      <div class="ts-chip"><span class="tv">Post-Deposit</span><span class="tl">Critical Phase</span></div>
    </div>
  </div>

  <!-- Row 2: Controls -->
  <div id="controls-row">
    <div class="phase-bar">
      <button class="phase-pill active" data-phase="all">All Phases</button>
      <button class="phase-pill" data-phase="discovery">Discovery</button>
      <button class="phase-pill" data-phase="application">Application</button>
      <button class="phase-pill crit" data-phase="post-deposit">âš  Post-Deposit</button>
      <button class="phase-pill" data-phase="departure">Departure</button>
      <button class="phase-pill" data-phase="post-abroad">Post-Abroad</button>
    </div>
    <div class="ctrl-div"></div>
    <div class="view-set">
      <button class="vbtn active" data-view="all">All Flows</button>
      <button class="vbtn" data-view="info">Info</button>
      <button class="vbtn" data-view="financial">Financial</button>
      <button class="vbtn" data-view="emotional">Emotional</button>
      <button class="vbtn" data-view="friction">âš  Friction</button>
    </div>
    <div class="search-box">
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input id="search" placeholder="Search stakeholdersâ€¦">
    </div>
    <button class="vbtn panel-btn" id="toggle-sb">âŠŸ Panel</button>
  </div>

</div>

<!-- â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="main">
  <div id="cvs">

    <!-- Scope tags -->
    <div id="scope-strip">
      <span class="scope-tag scope-in">ğŸ¯ In Scope: Post-Deposit Phase</span>
      <span class="scope-tag scope-out">âŠ˜ Out of Scope: Terra Dotta Â· Visa Policy Â· Host Institutions</span>
    </div>

    <!-- Phase badge (shown when phase filter active) -->
    <div id="phase-badge"><div id="phase-dot"></div><span id="phase-text"></span></div>

    <svg id="g">
      <defs>
        <!-- Small, clean arrowheads for each flow type -->
        <marker id="arr-info"       markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0.5 L0,5.5 L6,3 z" fill="#4A9EC4" opacity="0.8"/></marker>
        <marker id="arr-financial"  markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0.5 L0,5.5 L6,3 z" fill="#E8A040" opacity="0.8"/></marker>
        <marker id="arr-emotional"  markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0.5 L0,5.5 L6,3 z" fill="#C46090" opacity="0.8"/></marker>
        <marker id="arr-authority"  markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0.5 L0,5.5 L6,3 z" fill="#7C6FCD" opacity="0.8"/></marker>
        <marker id="arr-task"       markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0.5 L0,5.5 L6,3 z" fill="#6EB88A" opacity="0.8"/></marker>
        <marker id="arr-risk"       markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0.5 L0,5.5 L6,3 z" fill="#C05050" opacity="0.8"/></marker>
        <!-- Highlighted (selected) arrowheads â€” slightly larger -->
        <marker id="arr-info-hi"      markerWidth="7" markerHeight="7" refX="6" refY="3.5" orient="auto"><path d="M0,0.5 L0,6.5 L7,3.5 z" fill="#4A9EC4"/></marker>
        <marker id="arr-financial-hi" markerWidth="7" markerHeight="7" refX="6" refY="3.5" orient="auto"><path d="M0,0.5 L0,6.5 L7,3.5 z" fill="#E8A040"/></marker>
        <marker id="arr-emotional-hi" markerWidth="7" markerHeight="7" refX="6" refY="3.5" orient="auto"><path d="M0,0.5 L0,6.5 L7,3.5 z" fill="#C46090"/></marker>
        <marker id="arr-authority-hi" markerWidth="7" markerHeight="7" refX="6" refY="3.5" orient="auto"><path d="M0,0.5 L0,6.5 L7,3.5 z" fill="#7C6FCD"/></marker>
        <marker id="arr-task-hi"      markerWidth="7" markerHeight="7" refX="6" refY="3.5" orient="auto"><path d="M0,0.5 L0,6.5 L7,3.5 z" fill="#6EB88A"/></marker>
        <marker id="arr-risk-hi"      markerWidth="7" markerHeight="7" refX="6" refY="3.5" orient="auto"><path d="M0,0.5 L0,6.5 L7,3.5 z" fill="#C05050"/></marker>
        <filter id="shadow" x="-30%" y="-30%" width="160%" height="160%">
          <feDropShadow dx="0" dy="3" stdDeviation="6" flood-color="rgba(0,0,0,0.13)"/>
        </filter>
        <filter id="glow-sel" x="-60%" y="-60%" width="220%" height="220%">
          <feGaussianBlur stdDeviation="9" result="b"/>
          <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>
      <g id="groot"></g>
    </svg>

    <!-- Legend -->
    <div id="legend">
      <div class="leg-sec">
        <div class="leg-head">Stakeholder Type</div>
        <div class="leg-row"><div class="leg-dot" style="background:#D4A843"></div><span class="leg-lbl">OEA Units</span></div>
        <div class="leg-row"><div class="leg-dot" style="background:#7C6FCD"></div><span class="leg-lbl">Administration</span></div>
        <div class="leg-row"><div class="leg-dot" style="background:#3A9CC8"></div><span class="leg-lbl">Digital Channels</span></div>
        <div class="leg-row"><div class="leg-dot" style="background:#7A8C6E"></div><span class="leg-lbl">Partner Institutions</span></div>
        <div class="leg-row"><div class="leg-dot" style="background:#C4785A"></div><span class="leg-lbl">Financial & Academic</span></div>
        <div class="leg-row"><div class="leg-dot" style="background:#C4956A"></div><span class="leg-lbl">Student Stakeholders</span></div>
        <div class="leg-row"><div class="leg-dot" style="background:#C05050"></div><span class="leg-lbl">Risk Factors</span></div>
      </div>
      <div class="leg-sec">
        <div class="leg-head">Flow Type</div>
        <div class="leg-row"><div class="leg-line" style="background:#4A9EC4"></div><span class="leg-lbl">Information</span></div>
        <div class="leg-row"><div class="leg-line" style="background:#E8A040"></div><span class="leg-lbl">Financial</span></div>
        <div class="leg-row"><div class="leg-line" style="background:#C46090"></div><span class="leg-lbl">Emotional / Social</span></div>
        <div class="leg-row"><div class="leg-line" style="background:#7C6FCD"></div><span class="leg-lbl">Authority / Decision</span></div>
        <div class="leg-row"><div class="leg-line" style="background:#6EB88A"></div><span class="leg-lbl">Task / Coordination</span></div>
        <div class="leg-row"><div class="leg-line dashed"></div><span class="leg-lbl">Risk Flow</span></div>
      </div>
      <div class="leg-sec">
        <div class="leg-head">Relationship Health</div>
        <div class="leg-row"><div class="leg-dot" style="background:#E05050;box-shadow:0 0 0 2px rgba(192,80,80,0.22)"></div><span class="leg-lbl">Broken / Absent</span></div>
        <div class="leg-row"><div class="leg-dot" style="background:#E8A040"></div><span class="leg-lbl">Strained</span></div>
        <div class="leg-row"><div class="leg-dot" style="background:#5AB870"></div><span class="leg-lbl">Functioning</span></div>
      </div>
    </div>

    <!-- Zoom -->
    <div id="zoom-wrap">
      <button class="zbtn" id="zi">+</button>
      <button class="zbtn" id="zo">âˆ’</button>
      <button class="zbtn" id="zf" title="Fit view">âŠ™</button>
    </div>

  </div><!-- /cvs -->

  <!-- â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="sidebar">
    <div class="sb-head">
      <div class="sb-kicker" id="sb-kicker">Ecosystem Explorer</div>
      <div class="sb-title" id="sb-title">Select a node</div>
    </div>
    <div class="sb-body" id="sb-body">
      <div class="sb-empty">
        <div class="sb-empty-icon">â—</div>
        <div class="sb-empty-title">Stakeholder Detail</div>
        <div class="sb-empty-desc">Click any node to see goals, friction points, flow types, communication channels, and intervention opportunities.</div>
      </div>
    </div>
  </div>

</div><!-- /main -->

<div id="tt">
  <div class="tt-name" id="tt-name"></div>
  <div class="tt-sub"  id="tt-sub"></div>
  <div class="tt-st"   id="tt-st"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const FLOW = {
  info:      { color:'#4A9EC4', label:'Information' },
  financial: { color:'#E8A040', label:'Financial' },
  emotional: { color:'#C46090', label:'Emotional/Social' },
  authority: { color:'#7C6FCD', label:'Authority/Decision' },
  task:      { color:'#6EB88A', label:'Task/Coordination' },
  risk:      { color:'#C05050', label:'Risk Flow' },
};
const CAT = {
  oea:      { color:'#D4A843', text:'#3A2800', label:'OEA Unit' },
  admin:    { color:'#7C6FCD', text:'#FFFFFF', label:'Administration' },
  channel:  { color:'#3A9CC8', text:'#FFFFFF', label:'Digital Channel' },
  partner:  { color:'#7A8C6E', text:'#FFFFFF', label:'Partner Institution' },
  financial:{ color:'#C4785A', text:'#FFFFFF', label:'Financial & Academic' },
  student:  { color:'#C4956A', text:'#3A1A00', label:'Student Stakeholder' },
  risk:     { color:'#C05050', text:'#FFFFFF', label:'Risk Factor' },
};
const ST = { broken:'broken', strained:'strained', healthy:'healthy' };
const ALL = ['discovery','application','post-deposit','departure','post-abroad'];

// â”€â”€ NODES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Spacing scale: core = Â±0, inner ring ~180â€“280, mid ~380â€“460, outer ~520â€“620
// All r values slightly reduced from v3 to give breathing room

const NODES = [
  // Core
  { id:'pratt-oea', label:'Pratt OEA', sub:'Office of Education Abroad', cat:'oea', r:56,
    phases:ALL, scope:'in', power:90, interest:95, emotionalLoad:80,
    desc:'The institutional backbone of all outbound study abroad at Pratt. Coordinates both faculty-led and semester-exchange programs, manages partner relationships, and is the primary support system students should â€” but often can\'t â€” easily access.',
    painPoints:[
      { head:'Fragmented Communication Hub', body:'OEA sends information via Terra Dotta, email, and PDF docs. Students must reconcile 3 channels with no single source of truth.' },
      { head:'Coordination Overload', body:'Small staff managing multiple concurrent programs while fielding last-minute student questions that should be answered proactively.' }
    ],
    goals:['Increase student retention post-deposit','Maintain and grow 30+ partner relationships','Ensure program viability through consistent enrollment'],
    channels:['Terra Dotta','Email','In-person office hours'],
    interventions:['Planner Passport: centralized step-by-step tracker','Support Suitcase: structured orientation resource','Standardized faculty communication protocols'],
    x:0, y:0 },

  { id:'oea-exchange', label:'Exchange Program', sub:'Semester-long', cat:'oea', r:44,
    phases:ALL, scope:'in', power:70, interest:85, emotionalLoad:60,
    desc:'Manages full-semester exchanges placing Pratt students at partner universities globally. Bilateral agreement requires reciprocal student exchange.',
    painPoints:[{ head:'Credit Transfer Opacity', body:'Students unsure if abroad credits count toward their degree before committing.' }],
    goals:['Place students successfully at partner schools','Maintain reciprocal exchange agreements','Ensure seamless credit transfer'],
    channels:['Terra Dotta','Email','Partner school portals'],
    x:-230, y:55 },

  { id:'oea-faculty', label:'Faculty-led Program', sub:'Short-term Â· Critical', cat:'oea', r:44,
    phases:ALL, scope:'in', power:70, interest:90, emotionalLoad:75,
    desc:'Short-term programs led by Pratt faculty during academic breaks. HIGHEST WITHDRAWAL RISK â€” 39.28% withdraw post-deposit. Compressed timeline creates compounding pressure.',
    painPoints:[
      { head:'Post-Deposit Danger Zone', body:'After deposit students face visa, insurance, payments, and course approvals simultaneously with no clear sequence.' },
      { head:'Faculty Admin Overload', body:'Faculty absorb administrative tasks beyond their academic role, creating inconsistent student communication.' }
    ],
    goals:['Retain students post-deposit','Deliver enriching short-term experiences','Reduce admin burden on faculty'],
    channels:['Terra Dotta','Email','Canvas'],
    interventions:['Standardized pre-departure communication timeline','Faculty admin handoff to OEA staff'],
    x:230, y:55 },

  { id:'oea-staff-ex', label:'OEA Staff', sub:'Exchange (Olivia, Paige)', cat:'oea', r:25,
    phases:ALL, scope:'in', power:55, interest:85, emotionalLoad:70,
    desc:'Day-to-day operations staff for the Exchange Program. Primary student contact for logistics, documentation, and support.',
    painPoints:[{ head:'Reactive Support Model', body:'Staff spend significant time fielding urgent queries that proactive communication could prevent.' }],
    goals:['Process applications efficiently','Support students through documentation'],
    channels:['Email','Terra Dotta','In-person'],
    x:-310, y:175 },

  { id:'oea-staff-fl', label:'OEA Staff', sub:'Faculty-led (Paige, Topeka)', cat:'oea', r:25,
    phases:ALL, scope:'in', power:55, interest:85, emotionalLoad:75,
    desc:'Coordinates faculty-led program logistics. Often the last line of support when students are overwhelmed in the post-deposit phase.',
    painPoints:[{ head:'Surge Support Load', body:'Disproportionate contact volume in post-deposit window.' }],
    goals:['Coordinate program logistics','Support faculty leaders','Prevent last-minute withdrawals'],
    channels:['Email','Terra Dotta','Phone'],
    x:310, y:175 },

  { id:'faculty-prof', label:'Faculty / Professor', sub:'Program Leader', cat:'oea', r:32,
    phases:['application','post-deposit','departure','post-abroad'], scope:'in', power:65, interest:75, emotionalLoad:65,
    desc:'Pratt faculty who design and lead short-term programs. Currently absorbing admin tasks outside their academic role, creating inconsistent student experiences.',
    painPoints:[
      { head:'Role Boundary Erosion', body:'Faculty handle non-academic communication without clear protocols.' },
      { head:'Inconsistent Touchpoints', body:'Pre-departure communication quality varies widely by faculty leader.' }
    ],
    goals:['Lead enriching programs','Maintain professional work','Provide bounded student support'],
    channels:['Email','Canvas','Direct messaging'],
    interventions:['Define faculty vs. OEA communication boundaries','Provide faculty with templates'],
    x:450, y:55 },

  // Administration â€” top, spread wide
  { id:'pratt-admin', label:'Pratt Administration', sub:'Institutional Governance', cat:'admin', r:40,
    phases:ALL, scope:'out', power:95, interest:50, emotionalLoad:10,
    desc:'Central institutional authority. High power to allocate resources and set policy, but low direct student contact. Terra Dotta constraints and budget limits originate here.',
    painPoints:[{ head:'Institutional Constraint Origin', body:'Platform limitations and budget constraints originate at this level but OEA cannot change them.' }],
    goals:['Protect Pratt\'s international reputation','Generate tuition revenue','Maintain accreditation'],
    channels:['Internal governance','Budget cycles'],
    x:0, y:-330 },

  { id:'pratt-intl', label:'Pratt International', sub:'Department', cat:'admin', r:30,
    phases:ALL, scope:'out', power:60, interest:65, emotionalLoad:20,
    desc:'Bridges international strategy across Pratt departments. Limited direct student impact.',
    goals:['Support international student pipeline','Facilitate cross-departmental coordination'],
    channels:['Internal email','Meetings'],
    x:-235, y:-275 },

  // Digital channels â€” between admin and OEA, spread wide
  { id:'terra-dotta', label:'Terra Dotta', sub:'Application Platform', cat:'channel', r:34,
    phases:['application','post-deposit'], scope:'out', power:80, interest:0, emotionalLoad:0,
    desc:'The institutional application platform. INSTITUTIONAL CONSTRAINT â€” out of scope for redesign. Students use it for applications but find information fragmented with no unified task view.',
    painPoints:[
      { head:'Fragmentation Source', body:'Students must cross-reference Terra Dotta with email and PDFs to understand what to do next.' },
      { head:'Out of Scope', body:'Design interventions must work around this platform, not within it.' }
    ],
    goals:['Process applications','Store documentation','Track requirements'],
    channels:['Web platform'],
    x:-195, y:-160 },

  { id:'email-channel', label:'Email / PDF', sub:'Primary Comms Channel', cat:'channel', r:30,
    phases:['post-deposit'], scope:'out', power:40, interest:0, emotionalLoad:0,
    desc:'The dominant communication mode. Critical pre-departure information arrives by email and PDF. Students report very low retention of email-delivered information.',
    painPoints:[
      { head:'Email Overload', body:'Critical information buried in threads â€” students can\'t track what\'s actionable.' },
      { head:'No Progressive Disclosure', body:'PDFs dump all information at once rather than surfacing it when relevant.' }
    ],
    goals:['Deliver program information','Provide documentation guidance'],
    channels:['Email','PDF attachments'],
    x:190, y:-160 },

  { id:'canvas', label:'Canvas LMS', sub:'Academic Platform', cat:'channel', r:24,
    phases:['departure','post-abroad'], scope:'out', power:30, interest:0, emotionalLoad:0,
    desc:'Used primarily for academic coursework during and after the abroad program. Mostly backstage during the critical pre-departure withdrawal phase.',
    goals:['Deliver course content','Track academic progress'],
    channels:['Web platform'],
    x:360, y:-75 },

  // Partners â€” left cluster, pushed far left
  { id:'exchange-sch', label:'Exchange School', sub:'Intl Student Office', cat:'partner', r:36,
    phases:['application','post-deposit','departure','post-abroad'], scope:'out', power:70, interest:60, emotionalLoad:20,
    desc:'Partner universities managing incoming Pratt exchange students. Their deadlines and requirements add coordination load students must navigate with little OEA guidance.',
    painPoints:[{ head:'External Deadline Opacity', body:'Partner school requirements not clearly communicated through OEA.' }],
    goals:['Maintain bilateral exchange partnership','Integrate incoming exchange students'],
    channels:['Email','Partner portals','Direct OEA liaison'],
    x:-470, y:-60 },

  { id:'prof-foreign', label:'Foreign Faculty', sub:'At Exchange School', cat:'partner', r:28,
    phases:['departure','post-abroad'], scope:'out', power:40, interest:40, emotionalLoad:30,
    desc:'Faculty at partner institutions. Mostly active post-departure â€” limited influence on withdrawal risk.',
    goals:['Teach exchange students effectively','Build international academic network'],
    channels:['Direct instruction','Email'],
    x:-510, y:115 },

  { id:'peers-abroad', label:'Peers Abroad', sub:'Local & Intl Students', cat:'partner', r:24,
    phases:['departure','post-abroad'], scope:'out', power:20, interest:30, emotionalLoad:50,
    desc:'Local and international students at partner schools. Informal support network once abroad. No role in pre-departure retention.',
    goals:['Build international friendships','Cultural knowledge exchange'],
    channels:['Direct social interaction'],
    x:-490, y:245 },

  // Financial & Academic â€” right-left of student
  { id:'academic-adv', label:'Academic Advisor', sub:'Graduation Tracking', cat:'financial', r:32,
    phases:['discovery','application','post-deposit'], scope:'in', power:65, interest:70, emotionalLoad:40,
    desc:'Critical but often backstage actor. Students need advisors to confirm abroad courses won\'t derail graduation â€” but access is slow and happens too late.',
    painPoints:[
      { head:'Hidden Support System', body:'Advising support exists but isn\'t surfaced when students feel credit uncertainty.' },
      { head:'Late Intervention Risk', body:'Students sometimes reach post-deposit without knowing how abroad credits count.' }
    ],
    goals:['Ensure academic integrity of abroad experience','Track graduation pathway','Build student confidence'],
    channels:['In-person appointments','Email','One Pratt portal'],
    x:160, y:130 },

  { id:'fin-dept', label:'Financial Department', sub:'Aid & Payments', cat:'financial', r:30,
    phases:['application','post-deposit'], scope:'in', power:70, interest:55, emotionalLoad:30,
    desc:'Manages financial aid, tuition, scholarships, and payment schedules. Financial uncertainty is a top withdrawal driver yet this department is largely backstage.',
    painPoints:[
      { head:'Financial Opacity', body:'Cost breakdown and payment schedules remain unclear even after deposit is paid.' },
      { head:'Hidden Aid Resources', body:'Financial aid for study abroad exists but is not proactively surfaced.' }
    ],
    goals:['Process financial aid accurately','Provide payment clarity to students'],
    channels:['Terra Dotta','Email','In-person'],
    interventions:['Surface financial aid options early','Provide clear cost timeline before deposit'],
    x:-195, y:305 },

  { id:'geoblue', label:'GeoBlue Insurance', sub:'Emergency & Health', cat:'financial', r:25,
    phases:['post-deposit','departure'], scope:'in', power:60, interest:20, emotionalLoad:10,
    desc:'Mandatory health insurance for study abroad. Enrollment is a required post-deposit step students often don\'t know about until late.',
    painPoints:[{ head:'Hidden Requirement', body:'Surprise mandatory enrollment adds to post-deposit overwhelm.' }],
    goals:['Provide student health coverage abroad','Process enrollment efficiently'],
    channels:['Online enrollment portal','Email'],
    x:-330, y:260 },

  { id:'mentors', label:'Professional Mentors', sub:'Career Support', cat:'financial', r:25,
    phases:['post-deposit','departure','post-abroad'], scope:'in', power:30, interest:55, emotionalLoad:60,
    desc:'Career mentors who help students see the professional value of international experience. Emotional support role that sustains motivation through difficult logistics.',
    goals:['Connect experience to career outcomes','Provide motivational support'],
    channels:['Direct meetings','Email'],
    x:350, y:275 },

  // Students â€” bottom center cluster
  { id:'student', label:'Outbound Student', sub:'Primary Actor', cat:'student', r:52,
    phases:ALL, scope:'in', power:40, interest:95, emotionalLoad:95,
    desc:'The central actor the entire ecosystem must serve. Post-deposit, they face a coordination crisis: visa documents, financial payments, insurance, course approvals, and travel logistics arriving simultaneously with no clear sequence and no single guide.',
    painPoints:[
      { head:'Coordination Overload', body:'Multiple simultaneous requirements with no unified task view. The student becomes the de-facto coordinator of a fragmented process.' },
      { head:'Information Fragmentation', body:'Required information distributed across Terra Dotta, email, PDF, Canvas, and word-of-mouth.' },
      { head:'Emotional Compounding', body:'Each unresolved question raises anxiety. Uncertainty about visa bleeds into confidence about the whole decision.' },
      { head:'Financial Uncertainty', body:'After deposit, still unclear on total costs, aid availability, and payment deadlines.' },
      { head:'Invisible Support Systems', body:'Financial aid, advising, and insurance exist but are not surfaced when students feel most uncertain.' }
    ],
    goals:['Navigate pre-departure with confidence','Access support without friction','Feel prepared academically and financially'],
    channels:['Terra Dotta','Email','In-person','Word of mouth','Past students'],
    x:0, y:240 },

  { id:'parents', label:'Parents / Family', sub:'Emotional & Financial', cat:'student', r:30,
    phases:['discovery','application','post-deposit','departure'], scope:'in', power:50, interest:80, emotionalLoad:70,
    desc:'Family confidence in the process directly affects student decision-making. If family is also uncertain, withdrawal likelihood increases.',
    painPoints:[{ head:'Second-order Anxiety', body:'Parents who don\'t understand costs and process reinforce student hesitation.' }],
    goals:['Ensure child safety','Understand the financial commitment','Validate the decision to go abroad'],
    channels:['Direct family communication'],
    x:-120, y:410 },

  { id:'past-student', label:'Past Students', sub:'Alumni Mentors', cat:'student', r:26,
    phases:['discovery','application','post-deposit'], scope:'in', power:25, interest:70, emotionalLoad:65,
    desc:'One of the highest-trust information sources. Lived experience normalizes the process. Currently entirely informal and underutilized.',
    painPoints:[{ head:'Informal & Unstructured', body:'Knowledge shared ad hoc, not channeled to prospective students at key decision points.' }],
    goals:['Help current students through shared experience','Stay connected to Pratt community'],
    channels:['Word of mouth','Social media'],
    interventions:['Formalize peer mentorship program in post-deposit phase'],
    x:120, y:410 },

  { id:'peers-out', label:'Peer Outbound Students', sub:'Shared Journey', cat:'student', r:24,
    phases:['post-deposit','departure'], scope:'in', power:20, interest:75, emotionalLoad:65,
    desc:'Fellow students navigating the same process simultaneously. High mutual trust â€” can normalize confusion or amplify collective anxiety.',
    goals:['Share resources and information','Provide mutual emotional support'],
    channels:['Direct peer communication','Group chats'],
    x:260, y:385 },

  // Risk â€” bottom, spread wide
  { id:'passport', label:'Passport & Visa Docs', sub:'Documentation Risk', cat:'risk', r:29,
    phases:['post-deposit'], scope:'out', power:85, interest:0, emotionalLoad:0,
    desc:'Passport timelines and visa documentation are the #1 source of student confusion post-deposit. Requirements vary by destination and students have no single place to track them.',
    painPoints:[
      { head:'No Clear Timeline', body:'Students don\'t know when to start visa applications. Late start risks missing departure.' },
      { head:'Destination-Specific Opacity', body:'OEA communication doesn\'t always differentiate per-program visa requirements.' }
    ],
    goals:['Facilitate legal student entry to destination country'],
    channels:['Government portals','Consulate appointments','OEA guidance'],
    x:55, y:540 },

  { id:'flight', label:'Flight & Travel', sub:'Logistics Risk', cat:'risk', r:24,
    phases:['post-deposit','departure'], scope:'out', power:60, interest:0, emotionalLoad:0,
    desc:'Flight booking is tied to visa timeline. Students unsure whether to book before visa approval creates compounding risk.',
    painPoints:[{ head:'Visa-Flight Dependency', body:'OEA guidance on sequencing flight booking vs. visa approval is insufficient.' }],
    goals:['Enable student travel to destination'],
    channels:['Airline platforms','Travel tools'],
    x:215, y:530 },

  { id:'visa-dest', label:'Destination Visa Office', sub:'Foreign Government', cat:'risk', r:29,
    phases:['post-deposit'], scope:'out', power:90, interest:0, emotionalLoad:0,
    desc:'Foreign government visa administration. Entirely outside OEA\'s control. Unpredictable processing times create anxiety that without proactive support leads to withdrawal.',
    painPoints:[{ head:'Uncontrollable External', body:'OEA can only help students prepare â€” cannot influence timelines or requirements.' }],
    goals:['Process student visa applications'],
    channels:['Consulate portals','In-person appointments'],
    x:-165, y:540 },

  { id:'intl-rel', label:'International Relations', sub:'Geopolitical Risk', cat:'risk', r:24,
    phases:ALL, scope:'out', power:85, interest:0, emotionalLoad:0,
    desc:'Geopolitical context â€” travel advisories, diplomatic relations, political instability â€” can invalidate program destinations. Entirely outside OEA control.',
    goals:['Maintain international student exchange frameworks'],
    channels:['Government policy','Institutional advisories'],
    x:-340, y:500 },
];

// â”€â”€ EDGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EDGES = [
  { s:'pratt-admin', t:'pratt-oea',     flow:'authority', label:'Budget & institutional mandate',              status:'healthy',  phases:ALL,         w:2,   bi:false },
  { s:'pratt-oea',   t:'pratt-admin',   flow:'info',      label:'Program outcomes & enrollment data',          status:'healthy',  phases:ALL,         w:1.2 },
  { s:'pratt-admin', t:'terra-dotta',   flow:'authority', label:'Institutional constraint â€” platform locked',  status:'strained', phases:ALL,         w:1.8 },
  { s:'pratt-intl',  t:'pratt-oea',     flow:'task',      label:'International strategy coordination',         status:'healthy',  phases:ALL,         w:1.2 },
  { s:'pratt-oea',   t:'oea-exchange',  flow:'authority', label:'Manages exchange program',                    status:'healthy',  phases:ALL,         w:2 },
  { s:'pratt-oea',   t:'oea-faculty',   flow:'authority', label:'Manages faculty-led program',                 status:'healthy',  phases:ALL,         w:2 },
  { s:'pratt-oea',   t:'terra-dotta',   flow:'task',      label:'Publishes requirements & tracks applications',status:'strained', phases:['application','post-deposit'], w:1.8, channel:'Terra Dotta' },
  { s:'pratt-oea',   t:'email-channel', flow:'info',      label:'Sends pre-departure guidance',                status:'broken',   phases:['post-deposit'], w:1.8, friction:'Critical info buried â€” low student retention', channel:'Email' },
  { s:'oea-faculty', t:'email-channel', flow:'info',      label:'Program-specific updates',                    status:'strained', phases:['post-deposit'], w:1.4, friction:'Inconsistent across faculty leaders' },
  { s:'terra-dotta',   t:'student', flow:'info',      label:'Application status & document checklist', status:'strained', phases:['application','post-deposit'], w:2, friction:'Students must cross-reference with email & PDF', channel:'Terra Dotta' },
  { s:'email-channel', t:'student', flow:'info',      label:'Critical pre-departure information',      status:'broken',   phases:['post-deposit'], w:2, friction:'High volume, low retention, no task sequencing', channel:'Email' },
  { s:'canvas',        t:'student', flow:'info',      label:'Academic coursework and content',         status:'healthy',  phases:['departure','post-abroad'], w:1.2, channel:'Canvas' },
  { s:'oea-exchange', t:'oea-staff-ex', flow:'task', label:'Directs daily operations',         status:'healthy', phases:ALL,        w:1.2 },
  { s:'oea-faculty',  t:'oea-staff-fl', flow:'task', label:'Directs daily operations',         status:'healthy', phases:ALL,        w:1.2 },
  { s:'oea-faculty',  t:'faculty-prof', flow:'authority', label:'Program coordination',        status:'strained', phases:['post-deposit','departure'], w:1.8, friction:'Faculty absorbing admin tasks outside role' },
  { s:'oea-staff-ex', t:'student', flow:'info',      label:'Application & logistics support',  status:'healthy',  phases:['application','post-deposit'], w:1.8 },
  { s:'oea-staff-fl', t:'student', flow:'info',      label:'Program & pre-departure support',  status:'strained', phases:['post-deposit'], w:1.8, friction:'Reactive â€” only reached when student is overwhelmed' },
  { s:'faculty-prof', t:'student', flow:'info',      label:'Program details & academic guidance', status:'strained', phases:['post-deposit','departure'], w:1.8, friction:'Inconsistent by faculty admin style' },
  { s:'faculty-prof', t:'student', flow:'emotional', label:'On-ground support while abroad',   status:'healthy',  phases:['departure'], w:1.2 },
  { s:'oea-exchange', t:'exchange-sch', flow:'task', label:'Bilateral partnership management', status:'healthy', phases:['application','post-deposit'], w:1.8, bi:true },
  { s:'exchange-sch', t:'prof-foreign', flow:'authority', label:'Employs and directs faculty', status:'healthy', phases:['departure'], w:1.2 },
  { s:'prof-foreign', t:'student',  flow:'info',     label:'Teaching & guidance abroad',       status:'healthy', phases:['departure','post-abroad'], w:1.2 },
  { s:'peers-abroad', t:'student',  flow:'emotional',label:'Cultural exchange & peer connection', status:'healthy', phases:['departure','post-abroad'], w:1.2 },
  { s:'academic-adv', t:'student',  flow:'info',     label:'Credit approval & graduation path', status:'strained', phases:['discovery','application','post-deposit'], w:1.8, friction:'Not surfaced at moment of student uncertainty' },
  { s:'fin-dept',     t:'student',  flow:'financial',label:'Financial aid, payments, cost clarity', status:'broken', phases:['application','post-deposit'], w:2, friction:'Financial opacity is top withdrawal driver' },
  { s:'geoblue',      t:'student',  flow:'task',     label:'Mandatory insurance enrollment',   status:'strained', phases:['post-deposit'], w:1.4, friction:'Surprise requirement adds to post-deposit overload' },
  { s:'mentors',      t:'student',  flow:'emotional',label:'Career motivation & support',      status:'healthy',  phases:['post-deposit','departure'], w:1.2 },
  { s:'pratt-admin',  t:'fin-dept', flow:'authority',label:'Budget & aid policy',              status:'healthy',  phases:ALL, w:1.2 },
  { s:'parents',    t:'student',  flow:'emotional', label:'Family support & confidence',        status:'healthy',  phases:['application','post-deposit','departure'], w:1.8, bi:true },
  { s:'past-student',t:'student', flow:'info',      label:'Lived experience & normalisation',  status:'healthy',  phases:['discovery','application','post-deposit'], w:1.2 },
  { s:'peers-out',  t:'student',  flow:'emotional', label:'Peer support & anxiety sharing',    status:'healthy',  phases:['post-deposit','departure'], w:1.2, bi:true },
  { s:'passport',  t:'student',   flow:'risk', label:'Visa confusion â€” #1 withdrawal driver', status:'broken',  phases:['post-deposit'], w:2.5, risk:true, friction:'39% of students don\'t know what\'s required or when' },
  { s:'visa-dest', t:'student',   flow:'risk', label:'Unpredictable approval timeline',        status:'broken',  phases:['post-deposit'], w:2,   risk:true },
  { s:'visa-dest', t:'passport',  flow:'risk', label:'Governs documentation requirements',     status:'healthy', phases:['post-deposit'], w:1.2, risk:true },
  { s:'flight',    t:'student',   flow:'risk', label:'Visa-flight dependency confusion',       status:'strained',phases:['post-deposit'], w:1.2, risk:true },
  { s:'intl-rel',  t:'visa-dest', flow:'risk', label:'Policy influence on visa requirements',  status:'healthy', phases:ALL, w:1.2, risk:true },
  { s:'intl-rel',  t:'student',   flow:'risk', label:'Geopolitical safety advisories',         status:'healthy', phases:ALL, w:1,   risk:true },
];

const PHASES_META = {
  all:          { label:'All Phases',                    color:'#141418' },
  discovery:    { label:'Discovery',                     color:'#7A8C6E' },
  application:  { label:'Application',                   color:'#3A9CC8' },
  'post-deposit':{ label:'âš  Post-Deposit Â· Critical',   color:'#C05050' },
  departure:    { label:'Departure',                     color:'#D4A843' },
  'post-abroad':{ label:'Post-Abroad',                   color:'#7C6FCD' },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE & SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let xform    = d3.zoomIdentity;
let activePhase = 'all';
let activeView  = 'all';
let selectedId  = null;
let searchQ     = '';

const byId = {};
NODES.forEach(n => byId[n.id] = n);

const svg   = d3.select('#g');
const groot = d3.select('#groot');

const zoom = d3.zoom()
  .scaleExtent([0.1, 5])
  .on('zoom', e => { xform = e.transform; groot.attr('transform', e.transform); });

svg.call(zoom).on('dblclick.zoom', null);
svg.on('mousedown', () => svg.classed('dragging', true));
svg.on('mouseup mouseleave', () => svg.classed('dragging', false));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIT VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fitView(pad=90) {
  const W = document.getElementById('cvs').clientWidth;
  const H = document.getElementById('cvs').clientHeight;
  const vis = NODES.filter(n => nodeVisible(n));
  if (!vis.length) return;
  const xs = vis.map(n=>n.x), ys = vis.map(n=>n.y);
  const minX=Math.min(...xs)-90, maxX=Math.max(...xs)+90;
  const minY=Math.min(...ys)-90, maxY=Math.max(...ys)+90;
  const sc = Math.min((W-pad*2)/(maxX-minX),(H-pad*2)/(maxY-minY),1.3)*0.86;
  const cx=(minX+maxX)/2, cy=(minY+maxY)/2;
  svg.transition().duration(680).ease(d3.easeCubicInOut)
    .call(zoom.transform, d3.zoomIdentity.translate(W/2-sc*cx, H/2-sc*cy).scale(sc));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISIBILITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nodeVisible(n) {
  if (activePhase!=='all' && !n.phases.includes(activePhase)) return false;
  if (searchQ && !n.label.toLowerCase().includes(searchQ) && !(n.sub||'').toLowerCase().includes(searchQ)) return false;
  return true;
}
function edgeVisible(e) {
  if (activePhase!=='all' && !(e.phases||[]).includes(activePhase)) return false;
  if (!byId[e.s] || !byId[e.t]) return false;
  if (!nodeVisible(byId[e.s]) || !nodeVisible(byId[e.t])) return false;
  if (activeView==='friction') return e.status==='broken'||e.status==='strained';
  if (activeView!=='all' && e.flow!==activeView) return false;
  return true;
}
function nodeOpacity(n) {
  if (!nodeVisible(n)) return 0.07;
  if (selectedId) {
    if (n.id===selectedId) return 1;
    const conn = EDGES.some(e=>(e.s===selectedId&&e.t===n.id)||(e.t===selectedId&&e.s===n.id));
    return conn ? 0.9 : 0.12;
  }
  return 1;
}
function edgeOpacity(e) {
  if (!edgeVisible(e)) return 0;
  const base = e.risk ? 0.5 : 0.45;
  if (selectedId) {
    return (e.s===selectedId||e.t===selectedId) ? 1 : 0.04;
  }
  return base;
}
function worstStatus(nodeId) {
  const ss = EDGES.filter(e=>e.s===nodeId||e.t===nodeId).map(e=>e.status);
  if (ss.includes('broken')) return 'broken';
  if (ss.includes('strained')) return 'strained';
  return 'healthy';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  groot.selectAll('*').remove();

  // Post-deposit zone highlight
  if (activePhase==='post-deposit') {
    groot.append('ellipse')
      .attr('cx',0).attr('cy',170).attr('rx',320).attr('ry',200)
      .attr('fill','rgba(192,80,80,0.04)')
      .attr('stroke','rgba(192,80,80,0.14)').attr('stroke-width',1.5)
      .attr('stroke-dasharray','8 5');
  }

  // â”€ Edges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const EG = groot.append('g');
  EDGES.forEach(e => {
    const sn=byId[e.s], tn=byId[e.t];
    if (!sn||!tn) return;
    const op = edgeOpacity(e);
    if (op<0.01) return;

    const fc    = FLOW[e.flow]?.color||'#999';
    const isHL  = selectedId && (e.s===selectedId||e.t===selectedId);
    const sw    = isHL ? (e.w||1)*2.2 : (e.w||1)*1.3;

    const dx=tn.x-sn.x, dy=tn.y-sn.y;
    const dist=Math.sqrt(dx*dx+dy*dy)||1;
    const curv=Math.min(48,dist*0.15);
    const px=-dy/dist*curv, py=dx/dist*curv;
    const mx=(sn.x+tn.x)/2+px, my=(sn.y+tn.y)/2+py;
    const sr=sn.r+3, tr=tn.r+3;
    const sx=sn.x+dx/dist*sr, sy=sn.y+dy/dist*sr;
    const ex=tn.x-dx/dist*tr, ey=tn.y-dy/dist*tr;
    const pathD=`M${sx},${sy} Q${mx},${my} ${ex},${ey}`;

    const eg = EG.append('g');

    // Glow underlayer for broken/strained when selected
    if (isHL && (e.status==='broken'||e.status==='strained')) {
      const gc = e.status==='broken'?'#C05050':'#E8A040';
      eg.append('path').attr('d',pathD).attr('fill','none')
        .attr('stroke',gc).attr('stroke-width',sw+5).attr('stroke-opacity',0.12).attr('stroke-linecap','round');
    }

    // Main edge line
    const ln = eg.append('path').attr('d',pathD).attr('fill','none')
      .attr('stroke',fc).attr('stroke-width',sw)
      .attr('stroke-opacity',op).attr('stroke-linecap','round')
      .attr('stroke-dasharray',e.risk?'7,5':'none')
      .attr('marker-end',op>0.03?`url(#arr-${isHL?e.flow+'-hi':e.flow})`:'none');

    if (e.risk&&isHL) ln.attr('class','flow-anim').attr('stroke-dasharray','9,5');

    // Bidirectional return arrow
    if (e.bi && op>0.03) {
      const scat=CAT[sn.cat];
      eg.append('path').attr('d',`M${ex},${ey} Q${mx},${my} ${sx},${sy}`)
        .attr('fill','none').attr('stroke',scat.color)
        .attr('stroke-width',sw*0.7).attr('stroke-opacity',op*0.5)
        .attr('stroke-linecap','round')
        .attr('marker-end',`url(#arr-${e.flow})`);
    }

    // Edge label when highlighted
    if (isHL && op>0.3 && e.label) {
      const t=0.5;
      const bx=(1-t)*(1-t)*sx+2*(1-t)*t*mx+t*t*ex;
      const by=(1-t)*(1-t)*sy+2*(1-t)*t*my+t*t*ey;
      const lw=148, lh=22;
      eg.append('rect').attr('x',bx-lw/2).attr('y',by-13).attr('width',lw).attr('height',lh)
        .attr('rx',6).attr('fill','white').attr('opacity',0.95)
        .attr('filter','url(#shadow)');
      eg.append('text').attr('x',bx).attr('y',by+3.5)
        .attr('text-anchor','middle').attr('font-family','Sora,sans-serif')
        .attr('font-size',8.5).attr('font-weight',600)
        .attr('fill',e.status==='broken'?'#C05050':e.status==='strained'?'#B06020':'#2A2A2A')
        .text(e.label.length>36?e.label.slice(0,35)+'â€¦':e.label);
      if (e.friction && (e.status==='broken'||e.status==='strained')) {
        const tc=e.status==='broken'?'#C05050':'#C07030';
        const tbg=e.status==='broken'?'rgba(192,80,80,0.1)':'rgba(232,160,64,0.1)';
        const tl=e.status==='broken'?'âœ• Broken':'~ Strained';
        eg.append('rect').attr('x',bx-32).attr('y',by+12).attr('width',64).attr('height',14).attr('rx',7).attr('fill',tbg);
        eg.append('text').attr('x',bx).attr('y',by+22.5).attr('text-anchor','middle')
          .attr('font-family','Sora,sans-serif').attr('font-size',7.5).attr('font-weight',700).attr('fill',tc).text(tl);
      }
    }
  });

  // â”€ Nodes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const NG = groot.append('g');
  const tt  = document.getElementById('tt');
  const ttN = document.getElementById('tt-name');
  const ttS = document.getElementById('tt-sub');
  const ttSt= document.getElementById('tt-st');

  NODES.forEach(n => {
    const cat = CAT[n.cat];
    const op  = nodeOpacity(n);
    const isSel  = n.id===selectedId;
    const isConn = selectedId&&!isSel&&EDGES.some(e=>(e.s===selectedId&&e.t===n.id)||(e.t===selectedId&&e.s===n.id));
    const ws     = worstStatus(n.id);

    const g = NG.append('g')
      .attr('transform',`translate(${n.x},${n.y})`)
      .attr('opacity',op)
      .style('cursor',nodeVisible(n)?'pointer':'default');

    // Pulse for core nodes
    if ((n.id==='pratt-oea'||n.id==='student') && op>0.5 && !isSel) {
      g.append('circle').attr('r',n.r+11).attr('fill','none')
        .attr('stroke',cat.color).attr('stroke-width',1.5).attr('class','pulse-ring');
    }

    // Selection halo
    if (isSel) {
      g.append('circle').attr('r',n.r+10).attr('fill',cat.color).attr('opacity',0.12);
      g.append('circle').attr('r',n.r+7).attr('fill','none').attr('stroke',cat.color).attr('stroke-width',2.5).attr('opacity',0.9);
    }
    // Connected dashed ring
    if (isConn) {
      g.append('circle').attr('r',n.r+6).attr('fill','none').attr('stroke',cat.color)
        .attr('stroke-width',1.5).attr('opacity',0.4).attr('stroke-dasharray','4 3');
    }

    // Status ring
    if (ws==='broken') {
      g.append('circle').attr('r',n.r+5).attr('fill','none').attr('stroke','#C05050')
        .attr('stroke-width',2).attr('opacity',0.45).attr('stroke-dasharray','5 3')
        .attr('class','flow-anim');
    } else if (ws==='strained') {
      g.append('circle').attr('r',n.r+5).attr('fill','none').attr('stroke','#E8A040')
        .attr('stroke-width',1.5).attr('opacity',0.35);
    }

    // Out-of-scope faint dashed outer ring
    if (n.scope==='out' && n.cat!=='risk') {
      g.append('circle').attr('r',n.r+9).attr('fill','none').attr('stroke','rgba(0,0,0,0.06)')
        .attr('stroke-width',1).attr('stroke-dasharray','3,3');
    }
    // Risk nodes get dashed ring
    if (n.cat==='risk') {
      g.append('circle').attr('r',n.r+8).attr('fill','none').attr('stroke',cat.color)
        .attr('stroke-width',1.2).attr('opacity',0.25).attr('stroke-dasharray','5 4');
    }

    // Main circle
    g.append('circle').attr('r',n.r).attr('fill',cat.color)
      .attr('filter',isSel?'url(#glow-sel)':'url(#shadow)');

    // Specular
    g.append('circle').attr('cx',-n.r*0.25).attr('cy',-n.r*0.25).attr('r',n.r*0.52)
      .attr('fill','white').attr('opacity',0.09);

    // â”€â”€ Node label with proper padding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const words = n.label.split(' ');
    // Adaptive line-wrapping based on radius
    const charsPerLine = Math.floor(n.r * 0.42);
    const lines = wrapText(words, charsPerLine);
    const fs   = Math.max(7.5, Math.min(11, n.r * 0.20));
    const lh   = fs * 1.38;
    const hasSub = n.sub && n.r >= 28;
    const totalLabelH = lines.length * lh;
    // Center the text block vertically, push up slightly if sub-label present
    let baseY = -totalLabelH/2 + lh*0.4;
    if (hasSub) baseY -= fs*0.55;

    lines.forEach((line, i) => {
      // Clip line to fit inside node with 6px padding per side
      const maxW = (n.r - 6) * 2;
      const approxW = line.length * fs * 0.6;
      const displayLine = approxW > maxW ? clipToWidth(line, maxW, fs) : line;
      g.append('text')
        .attr('y', baseY + i*lh)
        .attr('text-anchor','middle')
        .attr('font-family','Sora,sans-serif')
        .attr('font-size', fs).attr('font-weight', 700)
        .attr('fill', cat.text)
        .attr('paint-order','stroke')
        .attr('stroke','transparent').attr('stroke-width',0)
        .text(displayLine);
    });

    if (hasSub) {
      const subFs = Math.max(6.5, fs*0.68);
      const subText = n.sub.length > 20 ? n.sub.slice(0,19)+'â€¦' : n.sub;
      g.append('text')
        .attr('y', baseY + totalLabelH + subFs*0.5)
        .attr('text-anchor','middle')
        .attr('font-family','Sora,sans-serif')
        .attr('font-size', subFs).attr('font-weight', 400)
        .attr('fill', cat.text).attr('opacity', 0.55)
        .text(subText);
    }

    // Out-of-scope label below node (small, muted)
    if (n.scope==='out') {
      g.append('text').attr('y', n.r+13).attr('text-anchor','middle')
        .attr('font-family','Sora,sans-serif').attr('font-size',7).attr('font-weight',600)
        .attr('fill','rgba(0,0,0,0.28)').attr('letter-spacing','0.06em')
        .text('OUT OF SCOPE');
    }

    // Events
    g.on('mouseenter', ev => {
      if (n.id===selectedId) return;
      ttN.textContent = n.label;
      ttS.textContent = n.sub||'';
      const w=worstStatus(n.id);
      if (w==='broken')   { ttSt.textContent='âš  Broken relationship'; ttSt.style.background='rgba(192,80,80,0.18)'; ttSt.style.color='#FF9090'; }
      else if (w==='strained') { ttSt.textContent='~ Strained relationship'; ttSt.style.background='rgba(232,160,64,0.18)'; ttSt.style.color='#FFB060'; }
      else { ttSt.textContent=''; ttSt.style.background=''; ttSt.style.color=''; }
      tt.classList.add('show');
    })
    .on('mousemove', ev => { tt.style.left=(ev.clientX+14)+'px'; tt.style.top=(ev.clientY-14)+'px'; })
    .on('mouseleave', () => tt.classList.remove('show'))
    .on('click', ev => {
      ev.stopPropagation();
      tt.classList.remove('show');
      if (!nodeVisible(n)) return;
      selectedId = (selectedId===n.id) ? null : n.id;
      selectedId ? populateSidebar(n) : clearSidebar();
      render();
    });
  });

  // Canvas click = deselect
  svg.on('click', ev => {
    if (ev.target===svg.node()||ev.target.tagName==='svg') {
      selectedId=null; clearSidebar(); render();
    }
  });
}

// Text wrapping helpers
function wrapText(words, charsPerLine) {
  if (!words.length) return [''];
  const lines = [];
  let cur = '';
  words.forEach(w => {
    const test = cur ? cur+' '+w : w;
    if (test.length <= charsPerLine) { cur=test; }
    else { if (cur) lines.push(cur); cur=w; }
  });
  if (cur) lines.push(cur);
  return lines.length ? lines : [words.join(' ')];
}
function clipToWidth(text, maxW, fs) {
  const approxCharW = fs * 0.6;
  const maxChars = Math.floor(maxW / approxCharW);
  return text.length > maxChars ? text.slice(0, maxChars-1)+'â€¦' : text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearSidebar() {
  document.getElementById('sb-kicker').textContent = 'Ecosystem Explorer';
  document.getElementById('sb-title').textContent  = 'Select a node';
  document.getElementById('sb-body').innerHTML = `
    <div class="sb-empty">
      <div class="sb-empty-icon">â—</div>
      <div class="sb-empty-title">Stakeholder Detail</div>
      <div class="sb-empty-desc">Click any node to explore goals, friction, flow types, channels, and interventions.</div>
    </div>`;
}

function populateSidebar(n) {
  const cat = CAT[n.cat];
  const ws  = worstStatus(n.id);
  const outE = EDGES.filter(e=>e.s===n.id && edgeVisible(e));
  const inE  = EDGES.filter(e=>e.t===n.id && edgeVisible(e));
  const connIds = new Set([...outE.map(e=>e.t),...inE.map(e=>e.s)]);

  document.getElementById('sb-kicker').textContent = cat.label.toUpperCase();
  document.getElementById('sb-title').textContent  = n.label;

  const scopeTag = n.scope==='in'
    ? `<span class="stag inscope">ğŸ¯ In Scope</span>`
    : `<span class="stag outscope">âŠ˜ Out of Scope</span>`;
  const wsTag = ws==='broken'
    ? `<span class="stag broken">âš  Friction Present</span>`
    : ws==='strained'
    ? `<span class="stag strained">~ Strained</span>`
    : `<span class="stag healthy">âœ“ Functioning</span>`;

  let h = `<div class="sb-ani">`;

  // Identity + description
  h += `<div class="sbs">
    <div class="node-badge" style="background:${cat.color}1A;color:${cat.color};border:1.5px solid ${cat.color}44;">
      <span style="width:6px;height:6px;border-radius:50%;background:${cat.color};display:inline-block;flex-shrink:0;"></span>
      ${cat.label}
    </div>
    <p class="sb-desc">${n.desc}</p>
    <div class="status-row">${wsTag}${scopeTag}</div>
  </div>`;

  // Profile meters
  h += `<div class="sbs">
    <div class="sbs-head">Stakeholder Profile</div>
    <div class="inf-bar">
      ${ir('Power',n.power,cat.color)}
      ${ir('Interest',n.interest,cat.color)}
      ${ir('Emotional Load',n.emotionalLoad,cat.color)}
      ${ir('Connections',Math.min(100,connIds.size*12),cat.color,connIds.size)}
    </div>
  </div>`;

  // Goals
  if (n.goals?.length) {
    h += `<div class="sbs"><div class="sbs-head">Goals <span class="sbs-count">${n.goals.length}</span></div><div class="goal-list">`;
    n.goals.forEach(g => h+=`<div class="goal-item"><div class="goal-dot" style="background:${cat.color}"></div><span>${g}</span></div>`);
    h += `</div></div>`;
  }

  // Pain points
  if (n.painPoints?.length) {
    h += `<div class="sbs"><div class="sbs-head" style="color:var(--broken)">âš  Friction Points <span class="sbs-count">${n.painPoints.length}</span></div>`;
    n.painPoints.forEach(p => h+=`<div class="pain-card"><div class="pain-head">â¬¤ ${p.head}</div>${p.body}</div>`);
    h += `</div>`;
  }

  // Channels
  if (n.channels?.length) {
    const chCol = {'Terra Dotta':['#4A9EC415','#2A7AA0'],'Email':['#C0505015','#A03030'],'Canvas':['#5AB87015','#3A7A52'],'In-person':['#7A8C6E15','#5A7A4A']};
    h += `<div class="sbs"><div class="sbs-head">Channels</div><div class="ch-wrap">`;
    n.channels.forEach(c => {
      const [bg,fg]=chCol[c]||['rgba(0,0,0,0.05)','var(--muted)'];
      h+=`<span class="ch-pill" style="background:${bg};color:${fg};">${c}</span>`;
    });
    h += `</div></div>`;
  }

  // Interventions
  if (n.interventions?.length) {
    h += `<div class="sbs"><div class="sbs-head" style="color:#2E7A46">ğŸ’¡ Interventions</div>`;
    n.interventions.forEach(iv => {
      const [title,...rest]=iv.split(':');
      h+=`<div class="int-card"><div class="int-head">â†’ ${title}</div><div class="int-body">${rest.join(':')}</div></div>`;
    });
    h += `</div>`;
  }

  // Outgoing flows
  if (outE.length) {
    h += `<div class="sbs"><div class="sbs-head">Sends <span class="sbs-count">${outE.length}</span></div><div class="flow-list">`;
    outE.forEach(e => h += fc(e,byId[e.t],'â†’',cat.color));
    h += `</div></div>`;
  }

  // Incoming flows
  if (inE.length) {
    h += `<div class="sbs"><div class="sbs-head">Receives <span class="sbs-count">${inE.length}</span></div><div class="flow-list">`;
    inE.forEach(e => h += fc(e,byId[e.s],'â†',CAT[byId[e.s]?.cat]?.color||'#999'));
    h += `</div></div>`;
  }

  // Connected chips
  if (connIds.size) {
    h += `<div class="sbs"><div class="sbs-head">Connected <span class="sbs-count">${connIds.size}</span></div><div class="conn-wrap">`;
    connIds.forEach(id => {
      const cn=byId[id]; if(!cn) return;
      const cc=CAT[cn.cat];
      h+=`<span class="conn-chip" data-id="${id}" style="border-color:${cc.color}55;color:${cc.color};">${cn.label}</span>`;
    });
    h += `</div></div>`;
  }

  h += `</div>`;
  document.getElementById('sb-body').innerHTML = h;

  document.querySelectorAll('.conn-chip[data-id]').forEach(c=>c.addEventListener('click',()=>jumpTo(c.dataset.id)));
  document.querySelectorAll('.flow-card[data-id]').forEach(c=>c.addEventListener('click',()=>jumpTo(c.dataset.id)));
}

function jumpTo(id) {
  const node=byId[id]; if(!node) return;
  selectedId=id; populateSidebar(node); render();
  const W=document.getElementById('cvs').clientWidth, H=document.getElementById('cvs').clientHeight;
  svg.transition().duration(480).ease(d3.easeCubicInOut)
    .call(zoom.transform,d3.zoomIdentity.translate(W/2-xform.k*node.x,H/2-xform.k*node.y).scale(xform.k));
}

function ir(label,val,color,disp) {
  return `<div class="inf-row">
    <span class="inf-lbl">${label}</span>
    <div class="inf-track"><div class="inf-fill" style="width:${Math.min(100,val)}%;background:${color}"></div></div>
    <span class="inf-val">${disp!==undefined?disp:val}</span>
  </div>`;
}

function fc(edge, other, dir, nodeColor) {
  if (!other) return '';
  const fc2 = FLOW[edge.flow]?.color||'#999';
  const stCls = edge.status==='broken'?'broken':edge.status==='strained'?'strained':'healthy';
  const stLbl = edge.status==='broken'?'âœ• Broken':edge.status==='strained'?'~ Strained':'âœ“ Healthy';
  return `<div class="flow-card" data-id="${other.id}">
    <div class="flow-dot" style="background:${fc2}"></div>
    <div class="flow-inner">
      <div class="flow-dir">${FLOW[edge.flow]?.label||edge.flow} ${dir} ${other.label}</div>
      <div class="flow-lbl">${edge.label}</div>
      ${edge.channel?`<div class="flow-ch"><span style="width:5px;height:5px;border-radius:50%;background:${nodeColor};display:inline-block;"></span>${edge.channel}</div>`:''}
      ${edge.friction
        ?`<div class="flow-status ${stCls}">${stLbl}: ${edge.friction}</div>`
        :`<div class="flow-status ${stCls}">${stLbl}</div>`}
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('zi').onclick = () => svg.transition().duration(240).call(zoom.scaleBy,1.3);
document.getElementById('zo').onclick = () => svg.transition().duration(240).call(zoom.scaleBy,0.77);
document.getElementById('zf').onclick = () => fitView();

document.getElementById('toggle-sb').onclick = function() {
  document.getElementById('sidebar').classList.toggle('closed');
  this.classList.toggle('active');
};

document.querySelectorAll('.phase-pill').forEach(btn => btn.addEventListener('click', () => {
  activePhase = btn.dataset.phase;
  document.querySelectorAll('.phase-pill').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  selectedId=null; clearSidebar();
  const pb=document.getElementById('phase-badge');
  const pd=document.getElementById('phase-dot');
  const pt=document.getElementById('phase-text');
  if (activePhase!=='all') {
    const pm=PHASES_META[activePhase];
    pd.style.background=pm.color; pt.textContent=pm.label; pb.classList.add('visible');
  } else pb.classList.remove('visible');
  render();
  requestAnimationFrame(()=>fitView());
}));

document.querySelectorAll('.vbtn[data-view]').forEach(btn => btn.addEventListener('click', () => {
  activeView=btn.dataset.view;
  document.querySelectorAll('.vbtn[data-view]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  render();
}));

document.getElementById('search').addEventListener('input', e => {
  searchQ=e.target.value.toLowerCase().trim();
  selectedId=null; clearSidebar(); render();
});

window.addEventListener('resize', render);

// â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
render();
requestAnimationFrame(()=>requestAnimationFrame(()=>fitView()));
</script>
</body>
</html>
